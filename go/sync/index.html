<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1">




<title>Golang sync åŒ…çš„ç›¸å…³ä½¿ç”¨æ–¹æ³• | Abnerçš„åšå®¢</title>
<link rel="canonical" href="https://abnerxc.github.io/go/sync/">
<meta property="og:type" content="article" />
<meta property="og:title" content="Golang sync åŒ…çš„ç›¸å…³ä½¿ç”¨æ–¹æ³• | Abnerçš„åšå®¢" />
<meta property="og:url" content="https://abnerxc.github.io/go/sync/" />








<link rel="stylesheet" href="/lib/icofont/icofont.min.css" />
<link rel="stylesheet" href="/css/syntax.css" />
<link rel="stylesheet" href="/css/style.css" />
<link rel="stylesheet" href="/css/custom.css" />
<script src="/js/copy-code-block.js"></script>
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

    </head>

    <body>
        <header class="header-wrapper">
    <div class="header">
        <a class="site-title" href="https://abnerxc.github.io/">Abnerçš„åšå®¢</a>

        <nav class="menu">
            
        </nav>
    </div>
</header>

        <main class="main-wrapper">
            <div class="main">
                

<section class="single">
    <h1 class="title">Golang sync åŒ…çš„ç›¸å…³ä½¿ç”¨æ–¹æ³•</h1>

    <div class="tip">
        <time datetime="2019-01-15 18:35:11 &#43;0800 CST">2019/01/15</time>
        <span class="split">Â·</span>
        <span> 835 words </span>
        <span class="split">Â·</span>
        <span>
            4 minutes to read
        </span>
    </div>

    <div class="taxonomies">
        
        <div>
            Categories:
            
                <a href="/categories/go">Go</a>
            
        </div>
        

        
    </div>

    
    
    <div class="post-toc">
        <h3>ç›®å½•</h3>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸ºä»€ä¹ˆéœ€è¦é”">ä¸ºä»€ä¹ˆéœ€è¦é”</a></li>
    <li><a href="#ä»€ä¹ˆæ˜¯äº’æ–¥é”-mutex">ä»€ä¹ˆæ˜¯äº’æ–¥é” Mutexï¼Ÿ</a></li>
    <li><a href="#ä»€ä¹ˆæ˜¯è¯»å†™é”-rwmutex">ä»€ä¹ˆæ˜¯è¯»å†™é” RWMutex?</a></li>
    <li><a href="#waitgroup-ä¾‹å­">WaitGroup ä¾‹å­</a></li>
    <li><a href="#cond-æ¡ä»¶å˜é‡">Cond æ¡ä»¶å˜é‡</a></li>
    <li><a href="#pool-ä¸´æ—¶å¯¹è±¡æ± ">Pool ä¸´æ—¶å¯¹è±¡æ± </a></li>
    <li><a href="#once-æ‰§è¡Œä¸€æ¬¡">Once æ‰§è¡Œä¸€æ¬¡</a></li>
  </ul>
</nav>
    </div>
    

    <hr />

    <div class="content">
        <h1 id="ä¸ºä»€ä¹ˆéœ€è¦é”">ä¸ºä»€ä¹ˆéœ€è¦é” <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e9%94%81" class="anchor">ğŸ”—</a></h1><p>åœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹æˆ–åç¨‹åŒæ—¶å»ä¿®æ”¹ä¸€ä¸ªå˜é‡ï¼Œå¯èƒ½ä¼šå‡ºç°å¦‚ä¸‹æƒ…å†µï¼š</p>
<pre tabindex="0"><code>package main

import (
    &#34;fmt&#34;
    &#34;sync&#34;
    &#34;time&#34;
)

func main() {
    var a = 0

    // å¯åŠ¨ 100 ä¸ªåç¨‹ï¼Œéœ€è¦è¶³å¤Ÿå¤§
    // var lock sync.Mutex
    for i := 0; i &lt; 100; i++ {
        go func(idx int) {
            // lock.Lock()
            // defer lock.Unlock()
            a += 1
            fmt.Printf(&#34;goroutine %d, a=%d\n&#34;, idx, a)
        }(i)
    }

    // ç­‰å¾… 1s ç»“æŸä¸»ç¨‹åº
    // ç¡®ä¿æ‰€æœ‰åç¨‹æ‰§è¡Œå®Œ
    time.Sleep(time.Second)
}
</code></pre><p>è§‚å¯Ÿæ‰“å°ç»“æœï¼Œæ˜¯å¦å‡ºç° a çš„å€¼æ˜¯ç›¸åŒçš„æƒ…å†µï¼ˆæœªå‡ºç°åˆ™é‡è¯•æˆ–è°ƒå¤§åç¨‹æ•°ï¼‰ï¼Œç­”æ¡ˆï¼šæ˜¯çš„ã€‚</p>
<p>æ˜¾ç„¶è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚å‡ºç°è¿™ç§æƒ…å†µçš„åŸå› æ˜¯ï¼Œåç¨‹ä¾æ¬¡æ‰§è¡Œï¼šä»å¯„å­˜å™¨è¯»å– a çš„å€¼ -&gt; ç„¶ååšåŠ æ³•è¿ç®— -&gt; æœ€åå†™ä¼šå¯„å­˜å™¨ã€‚è¯•æƒ³ï¼Œæ­¤æ—¶ä¸€ä¸ªåç¨‹å–å‡º a çš„å€¼ 3ï¼Œæ­£åœ¨åšåŠ æ³•è¿ç®—ï¼ˆè¿˜æœªå†™å›å¯„å­˜å™¨ï¼‰ã€‚åŒæ—¶å¦ä¸€ä¸ªåç¨‹æ­¤æ—¶å»å–ï¼Œå–å‡ºäº†åŒæ ·çš„ a çš„å€¼ 3ã€‚æœ€ç»ˆå¯¼è‡´çš„ç»“æœæ˜¯ï¼Œä¸¤ä¸ªåç¨‹äº§å‡ºçš„ç»“æœç›¸åŒï¼Œa ç›¸å½“äºåªå¢åŠ äº† 1ã€‚</p>
<p>æ‰€ä»¥ï¼Œé”çš„æ¦‚å¿µå°±æ˜¯ï¼Œæˆ‘æ­£åœ¨å¤„ç† aï¼ˆé”å®šï¼‰ï¼Œä½ ä»¬è°éƒ½åˆ«å’Œæˆ‘æŠ¢ï¼Œç­‰æˆ‘å¤„ç†å®Œäº†ï¼ˆè§£é”ï¼‰ï¼Œä½ ä»¬å†å¤„ç†ã€‚è¿™æ ·å°±å®ç°äº†ï¼ŒåŒæ—¶å¤„ç† a çš„åç¨‹åªæœ‰ä¸€ä¸ªï¼Œå°±å®ç°äº†åŒæ­¥ã€‚</p>
<p>+++</p>
<h1 id="ä»€ä¹ˆæ˜¯äº’æ–¥é”-mutex">ä»€ä¹ˆæ˜¯äº’æ–¥é” Mutexï¼Ÿ <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e4%ba%92%e6%96%a5%e9%94%81-mutex" class="anchor">ğŸ”—</a></h1><p>ä»€ä¹ˆæ˜¯äº’æ–¥é”ï¼Ÿå®ƒæ˜¯é”çš„ä¸€ç§å…·ä½“å®ç°ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>func (m *Mutex) Lock()
func (m *Mutex) Unlock()
</code></pre><p>åœ¨é¦–æ¬¡ä½¿ç”¨åä¸è¦å¤åˆ¶è¯¥äº’æ–¥é”ã€‚å¯¹ä¸€ä¸ªæœªé”å®šçš„äº’æ–¥é”è§£é”å°†ä¼šäº§ç”Ÿè¿è¡Œæ—¶é”™è¯¯ã€‚</p>
<p>ä¸€ä¸ªäº’æ–¥é”åªèƒ½åŒæ—¶è¢«ä¸€ä¸ª goroutine é”å®šï¼Œå…¶å®ƒ goroutine å°†é˜»å¡ç›´åˆ°äº’æ–¥é”è¢«è§£é”ï¼ˆé‡æ–°äº‰æŠ¢å¯¹äº’æ–¥é”çš„é”å®šï¼‰ã€‚å¦‚ï¼š</p>
<pre tabindex="0"><code>package main

import (
    &#34;fmt&#34;
    &#34;sync&#34;
    &#34;time&#34;
)

func main() {
    ch := make(chan struct{}, 2)

    var l sync.Mutex
    go func() {
        l.Lock()
        defer l.Unlock()
        fmt.Println(&#34;goroutine1: æˆ‘ä¼šé”å®šå¤§æ¦‚ 2s&#34;)
        time.Sleep(time.Second * 2)
        fmt.Println(&#34;goroutine1: æˆ‘è§£é”äº†ï¼Œä½ ä»¬å»æŠ¢å§&#34;)
        ch &lt;- struct{}{}
    }()

    go func() {
        fmt.Println(&#34;groutine2: ç­‰å¾…è§£é”&#34;)
        l.Lock()
        defer l.Unlock()
        fmt.Println(&#34;goroutine2: å“ˆå“ˆï¼Œæˆ‘é”å®šäº†&#34;)
        ch &lt;- struct{}{}
    }()

    // ç­‰å¾… goroutine æ‰§è¡Œç»“æŸ
    for i := 0; i &lt; 2; i++ {
        &lt;-ch
    }
}
</code></pre><blockquote>
<p>æ³¨æ„ï¼Œå¹³æ—¶æ‰€è¯´çš„é”å®šï¼Œå…¶å®å°±æ˜¯å»é”å®šäº’æ–¥é”ï¼Œè€Œä¸æ˜¯è¯´å»é”å®šä¸€æ®µä»£ç ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä»£ç æ‰§è¡Œåˆ°æœ‰é”çš„åœ°æ–¹æ—¶ï¼Œå®ƒè·å–ä¸åˆ°äº’æ–¥é”çš„é”å®šï¼Œä¼šé˜»å¡åœ¨é‚£é‡Œï¼Œä»è€Œè¾¾åˆ°æ§åˆ¶åŒæ­¥çš„ç›®çš„ã€‚</p>
</blockquote>
<p>+++</p>
<h1 id="ä»€ä¹ˆæ˜¯è¯»å†™é”-rwmutex">ä»€ä¹ˆæ˜¯è¯»å†™é” RWMutex? <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e8%af%bb%e5%86%99%e9%94%81-rwmutex" class="anchor">ğŸ”—</a></h1><p>é‚£ä¹ˆä»€ä¹ˆæ˜¯è¯»å†™é”å‘¢ï¼Ÿå®ƒæ˜¯é’ˆå¯¹è¯»å†™æ“ä½œçš„äº’æ–¥é”ï¼Œè¯»å†™é”ä¸äº’æ–¥é”æœ€å¤§çš„ä¸åŒå°±æ˜¯å¯ä»¥åˆ†åˆ«å¯¹ è¯»ã€å†™ è¿›è¡Œé”å®šã€‚ä¸€èˆ¬ç”¨åœ¨å¤§é‡è¯»æ“ä½œã€å°‘é‡å†™æ“ä½œçš„æƒ…å†µï¼š</p>
<pre tabindex="0"><code>func (rw *RWMutex) Lock()
func (rw *RWMutex) Unlock()

func (rw *RWMutex) RLock()
func (rw *RWMutex) RUnlock()
</code></pre><p>ç”±äºè¿™é‡Œéœ€è¦åŒºåˆ†è¯»å†™é”å®šï¼Œæˆ‘ä»¬è¿™æ ·å®šä¹‰ï¼š</p>
<ul>
<li>è¯»é”å®šï¼ˆRLockï¼‰ï¼Œå¯¹è¯»æ“ä½œè¿›è¡Œé”å®š</li>
<li>è¯»è§£é”ï¼ˆRUnlockï¼‰ï¼Œå¯¹è¯»é”å®šè¿›è¡Œè§£é”</li>
<li>å†™é”å®šï¼ˆLockï¼‰ï¼Œå¯¹å†™æ“ä½œè¿›è¡Œé”å®š</li>
<li>å†™è§£é”ï¼ˆUnlockï¼‰ï¼Œå¯¹å†™é”å®šè¿›è¡Œè§£é”</li>
</ul>
<p>åœ¨é¦–æ¬¡ä½¿ç”¨ä¹‹åï¼Œä¸è¦å¤åˆ¶è¯¥è¯»å†™é”ã€‚ä¸è¦æ··ç”¨é”å®šå’Œè§£é”ï¼Œå¦‚ï¼šLock å’Œ RUnlockã€RLock å’Œ Unlockã€‚å› ä¸ºå¯¹æœªè¯»é”å®šçš„è¯»å†™é”è¿›è¡Œè¯»è§£é”æˆ–å¯¹æœªå†™é”å®šçš„è¯»å†™é”è¿›è¡Œå†™è§£é”å°†ä¼šå¼•èµ·è¿è¡Œæ—¶é”™è¯¯ã€‚</p>
<p>å¦‚ä½•ç†è§£è¯»å†™é”å‘¢ï¼Ÿ</p>
<ol>
<li>åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ª goroutine èƒ½å¤Ÿè·å¾—å†™é”å®šã€‚</li>
<li>åŒæ—¶å¯ä»¥æœ‰ä»»æ„å¤šä¸ª gorouinte è·å¾—è¯»é”å®šã€‚</li>
<li>åŒæ—¶åªèƒ½å­˜åœ¨å†™é”å®šæˆ–è¯»é”å®šï¼ˆè¯»å’Œå†™äº’æ–¥ï¼‰ã€‚</li>
</ol>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æœ‰ä¸€ä¸ª goroutine è·å¾—å†™é”å®šï¼Œå…¶å®ƒæ— è®ºæ˜¯è¯»é”å®šè¿˜æ˜¯å†™é”å®šéƒ½å°†é˜»å¡ç›´åˆ°å†™è§£é”ï¼›å½“æœ‰ä¸€ä¸ª goroutine è·å¾—è¯»é”å®šï¼Œå…¶å®ƒè¯»é”å®šä»»ç„¶å¯ä»¥ç»§ç»­ï¼›å½“æœ‰ä¸€ä¸ªæˆ–ä»»æ„å¤šä¸ªè¯»é”å®šï¼Œå†™é”å®šå°†ç­‰å¾…æ‰€æœ‰è¯»é”å®šè§£é”ä¹‹åæ‰èƒ½å¤Ÿè¿›è¡Œå†™é”å®šã€‚æ‰€ä»¥è¯´è¿™é‡Œçš„è¯»é”å®šï¼ˆRLockï¼‰ç›®çš„å…¶å®æ˜¯å‘Šè¯‰å†™é”å®šï¼šæœ‰å¾ˆå¤šäººæ­£åœ¨è¯»å–æ•°æ®ï¼Œä½ ç»™æˆ‘ç«™ä¸€è¾¹å»ï¼Œç­‰å®ƒä»¬è¯»ï¼ˆè¯»è§£é”ï¼‰å®Œä½ å†æ¥å†™ï¼ˆå†™é”å®šï¼‰ã€‚</p>
<p>ä½¿ç”¨ä¾‹å­ï¼š</p>
<pre tabindex="0"><code>package main

import (
    &#34;fmt&#34;
    &#34;math/rand&#34;
    &#34;sync&#34;
)

var count int
var rw sync.RWMutex

func main() {
    ch := make(chan struct{}, 10)
    for i := 0; i &lt; 5; i++ {
        go read(i, ch)
    }
    for i := 0; i &lt; 5; i++ {
        go write(i, ch)
    }

    for i := 0; i &lt; 10; i++ {
        &lt;-ch
    }
}

func read(n int, ch chan struct{}) {
    rw.RLock()
    fmt.Printf(&#34;goroutine %d è¿›å…¥è¯»æ“ä½œ...\n&#34;, n)
    v := count
    fmt.Printf(&#34;goroutine %d è¯»å–ç»“æŸï¼Œå€¼ä¸ºï¼š%d\n&#34;, n, v)
    rw.RUnlock()
    ch &lt;- struct{}{}
}

func write(n int, ch chan struct{}) {
    rw.Lock()
    fmt.Printf(&#34;goroutine %d è¿›å…¥å†™æ“ä½œ...\n&#34;, n)
    v := rand.Intn(1000)
    count = v
    fmt.Printf(&#34;goroutine %d å†™å…¥ç»“æŸï¼Œæ–°å€¼ä¸ºï¼š%d\n&#34;, n, v)
    rw.Unlock()
    ch &lt;- struct{}{}
}
</code></pre><p>+++</p>
<h1 id="waitgroup-ä¾‹å­">WaitGroup ä¾‹å­ <a href="#waitgroup-%e4%be%8b%e5%ad%90" class="anchor">ğŸ”—</a></h1><p>WaitGroup ç”¨äºç­‰å¾…ä¸€ç»„ goroutine ç»“æŸï¼Œç”¨æ³•å¾ˆç®€å•ã€‚å®ƒæœ‰ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>func (wg *WaitGroup) Add(delta int)
func (wg *WaitGroup) Done()
func (wg *WaitGroup) Wait()
</code></pre><p>Add ç”¨æ¥æ·»åŠ  goroutine çš„ä¸ªæ•°ã€‚Done æ‰§è¡Œä¸€æ¬¡æ•°é‡å‡ 1ã€‚Wait ç”¨æ¥ç­‰å¾…ç»“æŸï¼š</p>
<pre tabindex="0"><code>package main

import (
    &#34;fmt&#34;
    &#34;sync&#34;
    &#34;time&#34;
)

func main() {
    var wg sync.WaitGroup

    for i := 0; i &lt; 5; i++ {
        // è®¡æ•°åŠ  1
        wg.Add(1)
        go func(i int) {
            // è®¡æ•°å‡ 1
            defer wg.Done()
            time.Sleep(time.Second * time.Duration(i))
            fmt.Printf(&#34;goroutine%d ç»“æŸ\n&#34;, i)
        }(i)
    }

    // ç­‰å¾…æ‰§è¡Œç»“æŸ
    wg.Wait()
    fmt.Println(&#34;æ‰€æœ‰ goroutine æ‰§è¡Œç»“æŸ&#34;)
}
</code></pre><p><em>æ³¨æ„ï¼Œwg.Add() æ–¹æ³•ä¸€å®šè¦åœ¨ goroutine å¼€å§‹å‰æ‰§è¡Œå“¦ã€‚</em></p>
<p>+++</p>
<h1 id="cond-æ¡ä»¶å˜é‡">Cond æ¡ä»¶å˜é‡ <a href="#cond-%e6%9d%a1%e4%bb%b6%e5%8f%98%e9%87%8f" class="anchor">ğŸ”—</a></h1><p>Cond å®ç°ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œå³ç­‰å¾…æˆ–å®£å¸ƒäº‹ä»¶å‘ç”Ÿçš„ goroutines çš„ä¼šåˆç‚¹ï¼Œå®ƒä¼šä¿å­˜ä¸€ä¸ªé€šçŸ¥åˆ—è¡¨ã€‚åŸºæœ¬æ€æƒ³æ˜¯å½“æŸä¸­çŠ¶æ€è¾¾æˆï¼Œgoroutine å°†ä¼šç­‰å¾…ï¼ˆWaitï¼‰åœ¨é‚£é‡Œï¼Œå½“æŸä¸ªæ—¶åˆ»çŠ¶æ€æ”¹å˜æ—¶é€šè¿‡é€šçŸ¥çš„æ–¹å¼ï¼ˆBroadcastï¼ŒSignalï¼‰çš„æ–¹å¼é€šçŸ¥ç­‰å¾…çš„ goroutineã€‚è¿™æ ·ï¼Œä¸æ»¡è¶³æ¡ä»¶çš„ goroutine å”¤é†’ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œæ»¡è¶³æ¡ä»¶çš„é‡æ–°è¿›å…¥ç­‰å¾…åºåˆ—ã€‚</p>
<pre tabindex="0"><code>type Cond struct {
    noCopy noCopy
  
    // L is held while observing or changing the condition
    L Locker
  
    notify  notifyList // é€šçŸ¥åˆ—è¡¨
    checker copyChecker
}
</code></pre><pre tabindex="0"><code>func NewCond(l Locker) *Cond
func (c *Cond) Broadcast()
func (c *Cond) Signal()
func (c *Cond) Wait()
</code></pre><p>Wait æ–¹æ³•ã€Signal æ–¹æ³•å’Œ Broadcast æ–¹æ³•ã€‚å®ƒä»¬åˆ†åˆ«ä»£è¡¨äº†ç­‰å¾…é€šçŸ¥ã€å•å‘é€šçŸ¥å’Œå¹¿æ’­é€šçŸ¥çš„æ“ä½œã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Wait æ–¹æ³•ï¼š</p>
<pre tabindex="0"><code>func (c *Cond) Wait() {
    c.checker.check()
    t := runtime_notifyListAdd(&amp;c.notify)
    c.L.Unlock()
    runtime_notifyListWait(&amp;c.notify, t)
    c.L.Lock()
}
</code></pre><p>å®ƒçš„æ“ä½œä¸ºï¼šåŠ å…¥åˆ°é€šçŸ¥åˆ—è¡¨ -&gt; è§£é” L -&gt; ç­‰å¾…é€šçŸ¥ -&gt; é”å®š Lã€‚å…¶ä½¿ç”¨æ–¹æ³•æ˜¯ï¼š</p>
<pre tabindex="0"><code>c.L.Lock()
for !condition() {
    c.Wait()
}
... make use of condition ...
c.L.Unlock()
</code></pre><p>ä¸¾ä¸ªä¾‹å­:</p>
<pre tabindex="0"><code>// Package main provides ...
package main

import (
    &#34;fmt&#34;
    &#34;sync&#34;
    &#34;time&#34;
)

var count int = 4

func main() {
    ch := make(chan struct{}, 5)

    // æ–°å»º cond
    var l sync.Mutex
    cond := sync.NewCond(&amp;l)

    for i := 0; i &lt; 5; i++ {
        go func(i int) {
            // äº‰æŠ¢äº’æ–¥é”çš„é”å®š
            cond.L.Lock()
            defer func() {
                cond.L.Unlock()
                ch &lt;- struct{}{}
            }()

            // æ¡ä»¶æ˜¯å¦è¾¾æˆ
            for count &gt; i {
                cond.Wait()
                fmt.Printf(&#34;æ”¶åˆ°ä¸€ä¸ªé€šçŸ¥ goroutine%d\n&#34;, i)
            }
            
            fmt.Printf(&#34;goroutine%d æ‰§è¡Œç»“æŸ\n&#34;, i)
        }(i)
    }

    // ç¡®ä¿æ‰€æœ‰ goroutine å¯åŠ¨å®Œæˆ
    time.Sleep(time.Millisecond * 20)
    
    // é”å®šä¸€ä¸‹
    fmt.Println(&#34;broadcast...&#34;)
    cond.L.Lock()
    count -= 1
    cond.Broadcast()
    cond.L.Unlock()

    time.Sleep(time.Second)
    fmt.Println(&#34;signal...&#34;)
    cond.L.Lock()
    count -= 2
    cond.Signal()
    cond.L.Unlock()

    time.Sleep(time.Second)
    fmt.Println(&#34;broadcast...&#34;)
    cond.L.Lock()
    count -= 1
    cond.Broadcast()
    cond.L.Unlock()

    for i := 0; i &lt; 5; i++ {
        &lt;-ch
    }
}
</code></pre><p>+++</p>
<h1 id="pool-ä¸´æ—¶å¯¹è±¡æ± ">Pool ä¸´æ—¶å¯¹è±¡æ±  <a href="#pool-%e4%b8%b4%e6%97%b6%e5%af%b9%e8%b1%a1%e6%b1%a0" class="anchor">ğŸ”—</a></h1><p>sync.Pool å¯ä»¥ä½œä¸ºä¸´æ—¶å¯¹è±¡çš„ä¿å­˜å’Œå¤ç”¨çš„é›†åˆã€‚å…¶ç»“æ„ä¸ºï¼š</p>
<pre tabindex="0"><code>type Pool struct {
    noCopy noCopy

    local     unsafe.Pointer // local fixed-size per-P pool, actual type is [P]poolLocal
    localSize uintptr        // size of the local array

    // New optionally specifies a function to generate
    // a value when Get would otherwise return nil.
    // It may not be changed concurrently with calls to Get.
    New func() interface{}
}

func (p *Pool) Get() interface{}
func (p *Pool) Put(x interface{})
</code></pre><p>æ–°é”® Pool éœ€è¦æä¾›ä¸€ä¸ª New æ–¹æ³•ï¼Œç›®çš„æ˜¯å½“è·å–ä¸åˆ°ä¸´æ—¶å¯¹è±¡æ—¶è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªï¼ˆä¸ä¼šä¸»åŠ¨åŠ å…¥åˆ° Pool ä¸­ï¼‰ï¼ŒGet å’Œ Put æ–¹æ³•éƒ½å¾ˆå¥½ç†è§£ã€‚</p>
<p>æ·±å…¥äº†è§£è¿‡ Go çš„åŒå­¦åº”è¯¥çŸ¥é“ï¼ŒGo çš„é‡è¦ç»„æˆç»“æ„ä¸º Mã€Pã€Gã€‚Pool å®é™…ä¸Šä¼šä¸ºæ¯ä¸€ä¸ªæ“ä½œå®ƒçš„ goroutine ç›¸å…³è”çš„ P éƒ½ç”Ÿæˆä¸€ä¸ªæœ¬åœ°æ± ã€‚å¦‚æœä»æœ¬åœ°æ±  Get å¯¹è±¡çš„æ—¶å€™ï¼Œæœ¬åœ°æ± æ²¡æœ‰ï¼Œåˆ™ä¼šä»å…¶å®ƒçš„ P æœ¬åœ°æ± è·å–ã€‚å› æ­¤ï¼ŒPool çš„ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯ï¼šå¯ä»¥æŠŠç”±å…¶ä¸­çš„å¯¹è±¡å€¼äº§ç”Ÿçš„å­˜å‚¨å‹åŠ›è¿›è¡Œåˆ†æ‘Šã€‚</p>
<p>å®ƒæœ‰ç€ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li>Pool ä¸­çš„å¯¹è±¡åœ¨ä»…æœ‰ Pool æœ‰ç€å”¯ä¸€ç´¢å¼•çš„æƒ…å†µä¸‹å¯èƒ½ä¼šè¢«è‡ªåŠ¨åˆ é™¤ï¼ˆå–å†³äºä¸‹ä¸€æ¬¡ GC æ‰§è¡Œçš„æ—¶é—´ï¼‰ã€‚</li>
<li>goroutines åç¨‹å®‰å…¨ï¼Œå¯ä»¥åŒæ—¶è¢«å¤šä¸ªåç¨‹ä½¿ç”¨ã€‚</li>
</ul>
<blockquote>
<p>GC çš„æ‰§è¡Œä¸€èˆ¬ä¼šä½¿ Pool ä¸­çš„å¯¹è±¡å…¨éƒ¨ç§»é™¤ã€‚</p>
</blockquote>
<p>é‚£ä¹ˆ Pool éƒ½é€‚ç”¨äºä»€ä¹ˆåœºæ™¯å‘¢ï¼Ÿä»å®ƒçš„ç‰¹ç‚¹æ¥è¯´ï¼Œé€‚ç”¨ä¸æ— çŠ¶æ€çš„å¯¹è±¡çš„å¤ç”¨ï¼Œè€Œä¸é€‚ç”¨ä¸å¦‚è¿æ¥æ± ä¹‹ç±»çš„ã€‚åœ¨ fmt åŒ…ä¸­æœ‰ä¸€ä¸ªå¾ˆå¥½çš„ä½¿ç”¨æ± çš„ä¾‹å­ï¼Œå®ƒç»´æŠ¤ä¸€ä¸ªåŠ¨æ€å¤§å°çš„ä¸´æ—¶è¾“å‡ºç¼“å†²åŒºã€‚</p>
<pre tabindex="0"><code>package main

import (
    &#34;bytes&#34;
    &#34;io&#34;
    &#34;os&#34;
    &#34;sync&#34;
    &#34;time&#34;
)

var bufPool = sync.Pool{
    New: func() interface{} {
        return new(bytes.Buffer)
    },
}

func timeNow() time.Time {
    return time.Unix(1136214245, 0)
}

func Log(w io.Writer, key, val string) {
    // è·å–ä¸´æ—¶å¯¹è±¡ï¼Œæ²¡æœ‰çš„è¯ä¼šè‡ªåŠ¨åˆ›å»º
    b := bufPool.Get().(*bytes.Buffer)
    b.Reset()
    b.WriteString(timeNow().UTC().Format(time.RFC3339))
    b.WriteByte(&#39; &#39;)
    b.WriteString(key)
    b.WriteByte(&#39;=&#39;)
    b.WriteString(val)
    w.Write(b.Bytes())
    // å°†ä¸´æ—¶å¯¹è±¡æ”¾å›åˆ° Pool ä¸­
    bufPool.Put(b)
}

func main() {
    Log(os.Stdout, &#34;path&#34;, &#34;/search?q=flowers&#34;)
}

æ‰“å°ç»“æœï¼š
2006-01-02T15:04:05Z path=/search?q=flowers
</code></pre><p>+++</p>
<h1 id="once-æ‰§è¡Œä¸€æ¬¡">Once æ‰§è¡Œä¸€æ¬¡ <a href="#once-%e6%89%a7%e8%a1%8c%e4%b8%80%e6%ac%a1" class="anchor">ğŸ”—</a></h1><p>ä½¿ç”¨ sync.Once å¯¹è±¡å¯ä»¥ä½¿å¾—å‡½æ•°å¤šæ¬¡è°ƒç”¨åªæ‰§è¡Œä¸€æ¬¡ã€‚å…¶ç»“æ„ä¸ºï¼š</p>
<pre tabindex="0"><code>type Once struct {
    m    Mutex
    done uint32
}

func (o *Once) Do(f func())
</code></pre><p>ç”¨ done æ¥è®°å½•æ‰§è¡Œæ¬¡æ•°ï¼Œç”¨ m æ¥ä¿è¯ä¿è¯ä»…è¢«æ‰§è¡Œä¸€æ¬¡ã€‚åªæœ‰ä¸€ä¸ª Do æ–¹æ³•ï¼Œè°ƒç”¨æ‰§è¡Œã€‚</p>

    </div>

    
</section>


            </div>
            <div class="side">
                <div class="side-categories">
    <h2>Categories</h2>
    <hr />

    <ul>
        
            <li>
                <a href="/categories/ai">ai(3)</a>
            </li>
        
            <li>
                <a href="/categories/go">go(23)</a>
            </li>
        
            <li>
                <a href="/categories/%E4%BB%A3%E7%A0%81">ä»£ç (2)</a>
            </li>
        
            <li>
                <a href="/categories/%E5%B7%A5%E5%85%B7">å·¥å…·(8)</a>
            </li>
        
            <li>
                <a href="/categories/%E9%80%86%E5%90%91">é€†å‘(3)</a>
            </li>
        
            <li>
                <a href="/categories/%E9%9D%A2%E8%AF%95">é¢è¯•(5)</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/note/">Recent Note</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/note/%E6%9E%B6%E6%9E%84%E8%80%83%E7%82%B9/">åœºæ™¯æ€»ç»“</a>
            </li>
        
            <li>
                <a href="/note/rdis-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%9B%AA%E5%B4%A9%E5%87%BB%E7%A9%BF%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/">ç¼“å­˜ç©¿é€ã€é›ªå´©ã€å‡»ç©¿çš„è§£å†³æ–¹æ³•</a>
            </li>
        
            <li>
                <a href="/note/redis-%E5%8D%95%E7%BA%BF%E7%A8%8B%E7%9A%84redis%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%AB/">å•çº¿ç¨‹çš„redisä¸ºä»€ä¹ˆå¿«</a>
            </li>
        
            <li>
                <a href="/note/redis-%E6%80%BB%E7%BB%93/">redisæ€»ç»“</a>
            </li>
        
            <li>
                <a href="/note/mysql-%E6%80%BB%E7%BB%93/">mysqlæ€»ç»“</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/android/">Recent Android</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/android/redroid%E4%BD%BF%E7%94%A8/">Redroidå®‰å“å®¹å™¨</a>
            </li>
        
            <li>
                <a href="/android/%E5%85%A5%E9%97%A8/">é€†å‘ç¯å¢ƒ-æ‚</a>
            </li>
        
            <li>
                <a href="/android/frida%E6%95%99%E7%A8%8B/">fridaæ•™ç¨‹</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/tool/">Recent Tool</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/tool/linux-almalinux%E4%BC%98%E5%8C%96/">AlmaLinux10</a>
            </li>
        
            <li>
                <a href="/tool/almalinux-k8s/">AlmaLinux-k8så®‰è£…</a>
            </li>
        
            <li>
                <a href="/tool/vscode%E6%8A%98%E8%85%BE/">vscodeæŠ˜è…¾</a>
            </li>
        
            <li>
                <a href="/tool/linux-ubuntu%E4%BC%98%E5%8C%96/">Ubuntuå¼€æœºä¼˜åŒ–</a>
            </li>
        
            <li>
                <a href="/tool/shell-ssh_script/">sshå¸¸ç”¨è„šæœ¬</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/llm/">Recent Llm</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/llm/transformers-%E5%85%A5%E9%97%A8%E7%AF%87/">Transformers-å…¥é—¨ç¯‡</a>
            </li>
        
            <li>
                <a href="/llm/%E6%A8%A1%E5%9E%8Bvllm%E9%83%A8%E7%BD%B2/">AIæ¨¡å‹VLLMéƒ¨ç½²</a>
            </li>
        
            <li>
                <a href="/llm/%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83/">AIæ¨¡å‹å¾®è°ƒ</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/go/">Recent Go</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/go/go%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0%E6%B7%B7%E5%90%88%E5%86%99%E5%B1%8F%E9%9A%9Cgc%E6%A8%A1%E5%BC%8F%E5%85%A8%E6%80%BB%E7%BB%93/">Goä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœGCæ¨¡å¼å…¨æ€»ç»“</a>
            </li>
        
            <li>
                <a href="/go/go%E4%B8%ADmake%E4%B8%8Enew%E5%8C%BA%E5%88%AB/">Goä¸­makeä¸newåŒºåˆ«</a>
            </li>
        
            <li>
                <a href="/go/go%E5%B8%B8%E7%94%A8bug%E5%92%8C%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%96%B9%E6%B3%95/">Goå¸¸ç”¨bugå’Œæ€§èƒ½é—®é¢˜çš„å®è·µæ–¹æ³•</a>
            </li>
        
            <li>
                <a href="/go/grpc%E6%80%BB%E7%BB%93/">GRPCç¬”è®°</a>
            </li>
        
            <li>
                <a href="/go/go%E7%9A%84defer%E6%80%BB%E7%BB%93/">Goçš„deferæ€»ç»“</a>
            </li>
        
    </ul>
</div>

                
            </div>
        </main>
        <footer class="footer">
    <div class="footer-row">
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/note/index.xml">
                    Feed of Note
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/android/index.xml">
                    Feed of Android
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/tool/index.xml">
                    Feed of Tool
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/llm/index.xml">
                    Feed of Llm
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/go/index.xml">
                    Feed of Go
                    <i class="icofont-rss"></i>
                </a>
            
        

        
            
            
        
    </div>

    
</footer>

    </body>
</html>
