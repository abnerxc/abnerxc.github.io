<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1">




<title>åŸºäºScratchåˆ›å»ºæœ€å°ä¸”å®‰å…¨çš„golang dockeré•œåƒ | Abnerçš„åšå®¢</title>
<link rel="canonical" href="https://abnerxc.github.io/go/%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E5%8F%91%E5%B8%83/">
<meta property="og:type" content="article" />
<meta property="og:title" content="åŸºäºScratchåˆ›å»ºæœ€å°ä¸”å®‰å…¨çš„golang dockeré•œåƒ | Abnerçš„åšå®¢" />
<meta property="og:url" content="https://abnerxc.github.io/go/%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E5%8F%91%E5%B8%83/" />








<link rel="stylesheet" href="/lib/icofont/icofont.min.css" />
<link rel="stylesheet" href="/css/syntax.css" />
<link rel="stylesheet" href="/css/style.css" />
<link rel="stylesheet" href="/css/custom.css" />
<script src="/js/copy-code-block.js"></script>
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

    </head>

    <body>
        <header class="header-wrapper">
    <div class="header">
        <a class="site-title" href="https://abnerxc.github.io/">Abnerçš„åšå®¢</a>

        <nav class="menu">
            
        </nav>
    </div>
</header>

        <main class="main-wrapper">
            <div class="main">
                

<section class="single">
    <h1 class="title">åŸºäºScratchåˆ›å»ºæœ€å°ä¸”å®‰å…¨çš„golang dockeré•œåƒ</h1>

    <div class="tip">
        <time datetime="2022-09-12 18:35:11 &#43;0800 CST">2022/09/12</time>
        <span class="split">Â·</span>
        <span> 244 words </span>
        <span class="split">Â·</span>
        <span>
            2 minutes to read
        </span>
    </div>

    <div class="taxonomies">
        
        <div>
            Categories:
            
                <a href="/categories/go">Go</a>
            
        </div>
        

        
    </div>

    
    
    <div class="post-toc">
        <h3>ç›®å½•</h3>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#golangæ‰“åŒ…é•œåƒå¯¹æ¯”">golangæ‰“åŒ…é•œåƒå¯¹æ¯”</a></li>
    <li><a href="#dockerçš„multi-stage-builds">dockerçš„Multi-stage builds</a></li>
  </ul>
</nav>
    </div>
    

    <hr />

    <div class="content">
        <h1 id="golangæ‰“åŒ…é•œåƒå¯¹æ¯”">golangæ‰“åŒ…é•œåƒå¯¹æ¯” <a href="#golang%e6%89%93%e5%8c%85%e9%95%9c%e5%83%8f%e5%af%b9%e6%af%94" class="anchor">ğŸ”—</a></h1><p>ä»dockerå®˜æ–¹ä¸‹è½½äº†é•œåƒä»¥åï¼Œå‘ç°ä¸€ä¸ªè¿è¡Œgoçš„ç¯å¢ƒéœ€è¦779M,æˆ‘å¾—é¡¹ç›®æ‰3~4Mï¼Œè¿™æ˜¯ä¸å¯ä»¥æ¥å—çš„</p>
<pre tabindex="0"><code>$ docker image list
golang    latest       1c1309ff8e0d        10 days ago         779MB
</code></pre><p>å°±ç®—ä½¿ç”¨alpineé•œåƒä¹Ÿæœ‰269M</p>
<pre tabindex="0"><code>$ docker image list
golang     alpine      bbab7aea1231        7 weeks ago         269MB
</code></pre><p>äºæ˜¯æ‰“ç®—è‡ªå·±æ„å»ºgolangè¿è¡Œçš„æœ€å°é•œåƒ.</p>
<h1 id="dockerçš„multi-stage-builds">dockerçš„Multi-stage builds <a href="#docker%e7%9a%84multi-stage-builds" class="anchor">ğŸ”—</a></h1><p>å¤šé˜¶æ®µæ„å»ºæ˜¯éœ€è¦Docker 17.05æˆ–æ›´é«˜ç‰ˆæœ¬çš„æ–°åŠŸèƒ½ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°docker scratch imageï¼ŒZero Bytes Imageã€‚éå¸¸é€‚åˆåµŒå…¥æˆ‘ä»¬çš„é™æ€äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<p>å…ˆä¸Šä»£ç ,ä¾‹å­è¯´æ˜</p>
<pre tabindex="0"><code>FROM        golang:alpine AS builder
MAINTAINER  Chen Xu &lt;abner510@126.com&gt;
RUN         apk update &amp;&amp; apk add --no-cache git ca-certificates tzdata &amp;&amp; update-ca-certificates &amp;&amp; adduser -D -g &#39;&#39; appuser
ENV         GOPROXY https://mirrors.aliyun.com/goproxy/
ENV         GO111MODULE on
WORKDIR     /go/cache
ADD         go.mod .
ADD         go.sum .
RUN         go mod download
WORKDIR     /go/src/ginx
ADD        . /go/src/ginx
RUN         CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo -ldflags=&#34;-w -s&#34; -o server

#å®¹å™¨æ„å»º
FROM        scratch AS prod
COPY        --from=builder /etc/passwd /etc/passwd
COPY        --from=builder /usr/share/zoneinfo /usr/share/zoneinfo
COPY        --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/
COPY        --from=builder /go/src/ginx/config /app/config
COPY        --from=builder /go/src/ginx/server /app
USER        appuser
EXPOSE      9000
CMD         [&#34;/app/server&#34;, &#34;-e=prod&#34;]
</code></pre><h2 id="ä»£ç ç¤ºä¾‹è¯´æ˜">ä»£ç ç¤ºä¾‹è¯´æ˜ <a href="#%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b%e8%af%b4%e6%98%8e" class="anchor">ğŸ”—</a></h2><h3 id="æ·»åŠ sslè¯ä¹¦æ”¯æŒhttpså’Œæ—¶åŒº">æ·»åŠ SSLè¯ä¹¦æ”¯æŒHTTPSå’Œæ—¶åŒº <a href="#%e6%b7%bb%e5%8a%a0ssl%e8%af%81%e4%b9%a6%e6%94%af%e6%8c%81https%e5%92%8c%e6%97%b6%e5%8c%ba" class="anchor">ğŸ”—</a></h3><pre tabindex="0"><code>apk add --no-cache git ca-certificates tzdata &amp;&amp; update-ca-certificates
</code></pre><h3 id="æ·»åŠ è¿è¡Œgolangçš„ç”¨æˆ·">æ·»åŠ è¿è¡Œgolangçš„ç”¨æˆ· <a href="#%e6%b7%bb%e5%8a%a0%e8%bf%90%e8%a1%8cgolang%e7%9a%84%e7%94%a8%e6%88%b7" class="anchor">ğŸ”—</a></h3><pre tabindex="0"><code>adduser -D -g &#39;&#39; appuser
</code></pre><h3 id="go-modæ¨¡å¼é¡¹ç›®åŒ…ç®¡ç†åŠ å¿«æ„å»ºé€Ÿåº¦">go modæ¨¡å¼é¡¹ç›®åŒ…ç®¡ç†ï¼ŒåŠ å¿«æ„å»ºé€Ÿåº¦ <a href="#go-mod%e6%a8%a1%e5%bc%8f%e9%a1%b9%e7%9b%ae%e5%8c%85%e7%ae%a1%e7%90%86%e5%8a%a0%e5%bf%ab%e6%9e%84%e5%bb%ba%e9%80%9f%e5%ba%a6" class="anchor">ğŸ”—</a></h3><pre tabindex="0"><code>ENV         GOPROXY https://goproxy.io   #è®¾ç½®ä»£ç†ï¼Œå›½å†…çš„å¢™ä½ æ‡‚çš„
ENV         GO111MODULE on  #å¼€å¯go mod æ¨¡å¼  ï¼Œè€ç‰ˆæœ¬GO111MODULE=auto é»˜è®¤æ˜¯è‡ªåŠ¨
WORKDIR     /go/cache  # è®¾ç½®åŒ…çš„ä¸‹è½½ç›®å½•
ADD         go.mod .
ADD         go.sum .
RUN         go mod download
</code></pre><p><img src="/img/go-alilog.jpeg" alt=""></p>
<h3 id="cgoç¼–è¯‘ä½¿ç”¨">CGOç¼–è¯‘ä½¿ç”¨ <a href="#cgo%e7%bc%96%e8%af%91%e4%bd%bf%e7%94%a8" class="anchor">ğŸ”—</a></h3><p>ç”±äºscratchæ˜¯ç©ºé•œåƒï¼Œ</p>
<pre tabindex="0"><code>CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo -ldflags=&#34;-w -s&#34; -o server
</code></pre><ul>
<li><code>CGO_ENABLED=0</code> ï¼ŒCGO_ENABLED æ˜¯å› ä¸º äº¤å‰ç¼–è¯‘ä¸æ”¯æŒ CGOï¼Œæˆ‘ä»¬è¿™é‡Œç¦ç”¨å®ƒ</li>
<li><code>-a -installsuffix cgo</code> , <code>-a</code>:å¼ºåˆ¶é‡æ–°ç¼–è¯‘ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸åˆ©ç”¨ç¼“å­˜æˆ–å·²ç¼–è¯‘å¥½çš„éƒ¨åˆ†æ–‡ä»¶ï¼Œç›´æ¥æ‰€æœ‰åŒ…éƒ½æ˜¯æœ€æ–°çš„ä»£ç é‡æ–°ç¼–è¯‘å’Œå…³è”; <code>installsuffix</code>:åœ¨è½¯ä»¶åŒ…å®‰è£…çš„ç›®å½•ä¸­å¢åŠ åç¼€æ ‡è¯†ï¼Œä»¥ä¿æŒè¾“å‡ºä¸é»˜è®¤ç‰ˆæœ¬åˆ†å¼€</li>
</ul>
<h3 id="åˆ¶ä½œgolangè¿è¡Œçš„å®¹å™¨">åˆ¶ä½œgolangè¿è¡Œçš„å®¹å™¨ <a href="#%e5%88%b6%e4%bd%9cgolang%e8%bf%90%e8%a1%8c%e7%9a%84%e5%ae%b9%e5%99%a8" class="anchor">ğŸ”—</a></h3><pre tabindex="0"><code>FROM        scratch AS prod #é•œåƒç‰ˆæœ¬
COPY        --from=builder /etc/passwd /etc/passwd  #è¿™é‡Œéœ€è¦ä½¿ç”¨appuerè´¦å·ä¿¡æ¯
COPY        --from=builder /usr/share/zoneinfo /usr/share/zoneinfo #æ—¶åŒº
COPY        --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ #SSLè¯ä¹¦æ–‡ä»¶
COPY        --from=builder /go/src/ginx/config /app/config #åº”ç”¨é…ç½®æ–‡ä»¶
COPY        --from=builder /go/src/ginx/server /app #åº”ç”¨äºŒè¿›åˆ¶æ–‡ä»¶
USER        appuser #è¿è¡Œç”¨æˆ·
EXPOSE      9000 #æš´éœ²ç«¯å£
CMD         [&#34;/app/server&#34;, &#34;-e=prod&#34;] #è¿è¡Œåº”ç”¨ï¼Œä¼ å…¥è¿è¡Œå‚æ•°
</code></pre><h3 id="é˜¿é‡Œäº‘åŠ é€Ÿç¿»å¢™é€Ÿåº¦">é˜¿é‡Œäº‘åŠ é€Ÿç¿»å¢™é€Ÿåº¦ <a href="#%e9%98%bf%e9%87%8c%e4%ba%91%e5%8a%a0%e9%80%9f%e7%bf%bb%e5%a2%99%e9%80%9f%e5%ba%a6" class="anchor">ğŸ”—</a></h3><p>1ã€åˆ›å»ºé•œåƒä»“åº“
<img src="/img/go-aliset1.jpeg" alt="">
2ã€é€‰æ‹©ä»“åº“<code>ç®¡ç†</code>ï¼Œè¿›è¡Œé…ç½®ä»“åº“
3ã€é€‰æ‹©gitä»“åº“ç‰ˆæœ¬ï¼Œè¿™é‡Œæœ¬äººæ˜¯æ”¾åœ¨githubä¸Šï¼Œæ‰€ä»¥é€‰æ‹©githubï¼Œè¿›è¡Œæˆæƒï¼Œé€‰æ‹©è‡ªå·±çš„ä»“åº“å’Œé¡¹ç›®ï¼Œé…ç½®å¦‚ä¸‹å…·ä½“dockerfileæ–‡ä»¶æ ¹æ®è‡ªå·±ä»“åº“è·¯å¾„é…ç½®
<img src="/img/go-aliset2.jpeg" alt="">
4ã€é€‰æ‹©æ„å»ºå³å¯</p>

    </div>

    
</section>


            </div>
            <div class="side">
                <div class="side-categories">
    <h2>Categories</h2>
    <hr />

    <ul>
        
            <li>
                <a href="/categories/ai">ai(3)</a>
            </li>
        
            <li>
                <a href="/categories/go">go(23)</a>
            </li>
        
            <li>
                <a href="/categories/%E4%BB%A3%E7%A0%81">ä»£ç (2)</a>
            </li>
        
            <li>
                <a href="/categories/%E5%B7%A5%E5%85%B7">å·¥å…·(8)</a>
            </li>
        
            <li>
                <a href="/categories/%E9%80%86%E5%90%91">é€†å‘(3)</a>
            </li>
        
            <li>
                <a href="/categories/%E9%9D%A2%E8%AF%95">é¢è¯•(5)</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/note/">Recent Note</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/note/%E6%9E%B6%E6%9E%84%E8%80%83%E7%82%B9/">åœºæ™¯æ€»ç»“</a>
            </li>
        
            <li>
                <a href="/note/rdis-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%9B%AA%E5%B4%A9%E5%87%BB%E7%A9%BF%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/">ç¼“å­˜ç©¿é€ã€é›ªå´©ã€å‡»ç©¿çš„è§£å†³æ–¹æ³•</a>
            </li>
        
            <li>
                <a href="/note/redis-%E5%8D%95%E7%BA%BF%E7%A8%8B%E7%9A%84redis%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%AB/">å•çº¿ç¨‹çš„redisä¸ºä»€ä¹ˆå¿«</a>
            </li>
        
            <li>
                <a href="/note/redis-%E6%80%BB%E7%BB%93/">redisæ€»ç»“</a>
            </li>
        
            <li>
                <a href="/note/mysql-%E6%80%BB%E7%BB%93/">mysqlæ€»ç»“</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/android/">Recent Android</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/android/redroid%E4%BD%BF%E7%94%A8/">Redroidå®‰å“å®¹å™¨</a>
            </li>
        
            <li>
                <a href="/android/%E5%85%A5%E9%97%A8/">é€†å‘ç¯å¢ƒ-æ‚</a>
            </li>
        
            <li>
                <a href="/android/frida%E6%95%99%E7%A8%8B/">fridaæ•™ç¨‹</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/tool/">Recent Tool</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/tool/linux-almalinux%E4%BC%98%E5%8C%96/">AlmaLinux10</a>
            </li>
        
            <li>
                <a href="/tool/almalinux-k8s/">AlmaLinux-k8så®‰è£…</a>
            </li>
        
            <li>
                <a href="/tool/vscode%E6%8A%98%E8%85%BE/">vscodeæŠ˜è…¾</a>
            </li>
        
            <li>
                <a href="/tool/linux-ubuntu%E4%BC%98%E5%8C%96/">Ubuntuå¼€æœºä¼˜åŒ–</a>
            </li>
        
            <li>
                <a href="/tool/shell-ssh_script/">sshå¸¸ç”¨è„šæœ¬</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/llm/">Recent Llm</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/llm/transformers-%E5%85%A5%E9%97%A8%E7%AF%87/">Transformers-å…¥é—¨ç¯‡</a>
            </li>
        
            <li>
                <a href="/llm/%E6%A8%A1%E5%9E%8Bvllm%E9%83%A8%E7%BD%B2/">AIæ¨¡å‹VLLMéƒ¨ç½²</a>
            </li>
        
            <li>
                <a href="/llm/%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83/">AIæ¨¡å‹å¾®è°ƒ</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/go/">Recent Go</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/go/go%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0%E6%B7%B7%E5%90%88%E5%86%99%E5%B1%8F%E9%9A%9Cgc%E6%A8%A1%E5%BC%8F%E5%85%A8%E6%80%BB%E7%BB%93/">Goä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœGCæ¨¡å¼å…¨æ€»ç»“</a>
            </li>
        
            <li>
                <a href="/go/go%E4%B8%ADmake%E4%B8%8Enew%E5%8C%BA%E5%88%AB/">Goä¸­makeä¸newåŒºåˆ«</a>
            </li>
        
            <li>
                <a href="/go/go%E5%B8%B8%E7%94%A8bug%E5%92%8C%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%96%B9%E6%B3%95/">Goå¸¸ç”¨bugå’Œæ€§èƒ½é—®é¢˜çš„å®è·µæ–¹æ³•</a>
            </li>
        
            <li>
                <a href="/go/grpc%E6%80%BB%E7%BB%93/">GRPCç¬”è®°</a>
            </li>
        
            <li>
                <a href="/go/go%E7%9A%84defer%E6%80%BB%E7%BB%93/">Goçš„deferæ€»ç»“</a>
            </li>
        
    </ul>
</div>

                
            </div>
        </main>
        <footer class="footer">
    <div class="footer-row">
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/note/index.xml">
                    Feed of Note
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/android/index.xml">
                    Feed of Android
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/tool/index.xml">
                    Feed of Tool
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/llm/index.xml">
                    Feed of Llm
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/go/index.xml">
                    Feed of Go
                    <i class="icofont-rss"></i>
                </a>
            
        

        
            
            
        
    </div>

    
</footer>

    </body>
</html>
