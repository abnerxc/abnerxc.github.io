<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1">




<title>Go-channelæ€»ç»“ | Abnerçš„åšå®¢</title>
<link rel="canonical" href="https://abnerxc.github.io/go/channel%E6%80%BB%E7%BB%93/">
<meta property="og:type" content="article" />
<meta property="og:title" content="Go-channelæ€»ç»“ | Abnerçš„åšå®¢" />
<meta property="og:url" content="https://abnerxc.github.io/go/channel%E6%80%BB%E7%BB%93/" />








<link rel="stylesheet" href="/lib/icofont/icofont.min.css" />
<link rel="stylesheet" href="/css/syntax.css" />
<link rel="stylesheet" href="/css/style.css" />
<link rel="stylesheet" href="/css/custom.css" />
<script src="/js/copy-code-block.js"></script>
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

    </head>

    <body>
        <header class="header-wrapper">
    <div class="header">
        <a class="site-title" href="https://abnerxc.github.io/">Abnerçš„åšå®¢</a>

        <nav class="menu">
            
        </nav>
    </div>
</header>

        <main class="main-wrapper">
            <div class="main">
                

<section class="single">
    <h1 class="title">Go-channelæ€»ç»“</h1>

    <div class="tip">
        <time datetime="2021-03-15 18:35:11 &#43;0800 CST">2021/03/15</time>
        <span class="split">Â·</span>
        <span> 618 words </span>
        <span class="split">Â·</span>
        <span>
            3 minutes to read
        </span>
    </div>

    <div class="taxonomies">
        
        <div>
            Categories:
            
                <a href="/categories/go">Go</a>
            
        </div>
        

        
    </div>

    
    
    <div class="post-toc">
        <h3>ç›®å½•</h3>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#channelçš„ä½¿ç”¨åœºæ™¯">channelçš„ä½¿ç”¨åœºæ™¯</a></li>
    <li><a href="#channelçš„åŸºæœ¬æ“ä½œå’Œæ³¨æ„äº‹é¡¹">channelçš„åŸºæœ¬æ“ä½œå’Œæ³¨æ„äº‹é¡¹</a></li>
    <li><a href="#ä½¿ç”¨for-rangeè¯»channel">ä½¿ç”¨for rangeè¯»channel</a></li>
    <li><a href="#ä½¿ç”¨vok---ch--selectæ“ä½œåˆ¤æ–­channelæ˜¯å¦å…³é—­">ä½¿ç”¨v,ok := &lt;-ch + selectæ“ä½œåˆ¤æ–­channelæ˜¯å¦å…³é—­</a></li>
    <li><a href="#ä½¿ç”¨selectå¤„ç†å¤šä¸ªchannel">ä½¿ç”¨selectå¤„ç†å¤šä¸ªchannel</a></li>
    <li><a href="#ä½¿ç”¨channelçš„å£°æ˜æ§åˆ¶è¯»å†™æƒé™">ä½¿ç”¨channelçš„å£°æ˜æ§åˆ¶è¯»å†™æƒé™</a></li>
    <li><a href="#ä½¿ç”¨ç¼“å†²channelå¢å¼ºå¹¶å‘">ä½¿ç”¨ç¼“å†²channelå¢å¼ºå¹¶å‘</a></li>
    <li><a href="#ä¸ºæ“ä½œåŠ ä¸Šè¶…æ—¶">ä¸ºæ“ä½œåŠ ä¸Šè¶…æ—¶</a></li>
    <li><a href="#ä½¿ç”¨closechå…³é—­æ‰€æœ‰ä¸‹æ¸¸åç¨‹">ä½¿ç”¨<code>close(ch)</code>å…³é—­æ‰€æœ‰ä¸‹æ¸¸åç¨‹</a></li>
    <li><a href="#ä½¿ç”¨chan-structä½œä¸ºä¿¡å·channel">ä½¿ç”¨chan struct{}ä½œä¸ºä¿¡å·channel</a></li>
    <li><a href="#ä½¿ç”¨channelä¼ é€’ç»“æ„ä½“çš„æŒ‡é’ˆè€Œéç»“æ„ä½“">ä½¿ç”¨channelä¼ é€’ç»“æ„ä½“çš„æŒ‡é’ˆè€Œéç»“æ„ä½“</a></li>
    <li><a href="#ä½¿ç”¨channelä¼ é€’channel">ä½¿ç”¨channelä¼ é€’channel</a></li>
  </ul>
</nav>
    </div>
    

    <hr />

    <div class="content">
        <h1 id="channelçš„ä½¿ç”¨åœºæ™¯">channelçš„ä½¿ç”¨åœºæ™¯ <a href="#channel%e7%9a%84%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af" class="anchor">ğŸ”—</a></h1><p>æŠŠchannelç”¨åœ¨æ•°æ®æµåŠ¨çš„åœ°æ–¹ï¼š</p>
<ul>
<li>æ¶ˆæ¯ä¼ é€’ã€æ¶ˆæ¯è¿‡æ»¤</li>
<li>ä¿¡å·å¹¿æ’­</li>
<li>äº‹ä»¶è®¢é˜…ä¸å¹¿æ’­</li>
<li>è¯·æ±‚ã€å“åº”è½¬å‘</li>
<li>ä»»åŠ¡åˆ†å‘</li>
<li>ç»“æœæ±‡æ€»</li>
<li>å¹¶å‘æ§åˆ¶</li>
<li>åŒæ­¥ä¸å¼‚æ­¥</li>
</ul>
<h1 id="channelçš„åŸºæœ¬æ“ä½œå’Œæ³¨æ„äº‹é¡¹">channelçš„åŸºæœ¬æ“ä½œå’Œæ³¨æ„äº‹é¡¹ <a href="#channel%e7%9a%84%e5%9f%ba%e6%9c%ac%e6%93%8d%e4%bd%9c%e5%92%8c%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" class="anchor">ğŸ”—</a></h1><p>channel å­˜åœ¨3ç§çŠ¶æ€</p>
<ol>
<li>nil,æœªåˆå§‹åŒ–ï¼Œåˆšåˆšç”³æ˜æˆ–è€…æ‰‹åŠ¨å¤åˆ¶ä¸ºnil</li>
<li>activeï¼Œæ­£å¸¸è¿è¡Œä¸­çš„å¯è¯»å¯å†™</li>
<li>closed,å…³é—­æ—¶ï¼Œ<strong>åƒä¸‡ä¸è¦è®¤ä¸ºå…³é—­ä»¥åï¼Œchannelçš„å€¼æ˜¯nil</strong></li>
</ol>
<p>channel å¯è¿›è¡Œ3ç§æ“ä½œ</p>
<ol>
<li>è¯»</li>
<li>å†™</li>
<li>å…³é—­</li>
</ol>
<p>3ç§çŠ¶æ€å­˜åœ¨9ç§æƒ…å†µ</p>
<table>
  <thead>
      <tr>
          <th>æ“ä½œ</th>
          <th>nilçš„channel</th>
          <th>æ­£å¸¸channel</th>
          <th>å·²å…³é—­channel</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>&lt;- ch</td>
          <td>é˜»å¡</td>
          <td>æˆåŠŸoré˜»å¡</td>
          <td>è¯»åˆ°é›¶å€¼</td>
      </tr>
      <tr>
          <td>ch &lt;-</td>
          <td>é˜»å¡</td>
          <td>æˆåŠŸoré˜»å¡</td>
          <td>panic</td>
      </tr>
      <tr>
          <td>close(ch)</td>
          <td>panic</td>
          <td>æˆåŠŸ</td>
          <td>panic</td>
      </tr>
  </tbody>
</table>
<p>å¯¹äºnilé€šé“çš„æƒ…å†µï¼Œä¹Ÿå¹¶éå®Œå…¨éµå¾ªä¸Šè¡¨ï¼Œæœ‰1ä¸ªç‰¹æ®Šåœºæ™¯ï¼šå½“nilçš„é€šé“åœ¨selectçš„æŸä¸ªcaseä¸­æ—¶ï¼Œè¿™ä¸ªcaseä¼šé˜»å¡ï¼Œä½†ä¸ä¼šé€ æˆæ­»é”</p>
<h1 id="ä½¿ç”¨for-rangeè¯»channel">ä½¿ç”¨for rangeè¯»channel <a href="#%e4%bd%bf%e7%94%a8for-range%e8%af%bbchannel" class="anchor">ğŸ”—</a></h1><ul>
<li>åœºæ™¯</li>
</ul>
<p>å½“éœ€è¦ä¸æ–­ä»channelè¯»å–æ•°æ®æ—¶ã€‚</p>
<ul>
<li>åŸç†</li>
</ul>
<p>ä½¿ç”¨for-rangeè¯»å–channelï¼Œè¿™æ ·æ—¢å®‰å…¨åˆä¾¿åˆ©ï¼Œå½“channelå…³é—­æ—¶ï¼Œforå¾ªç¯ä¼šè‡ªåŠ¨é€€å‡ºï¼Œæ— éœ€ä¸»åŠ¨ç›‘æµ‹channelæ˜¯å¦å…³é—­ï¼Œå¯ä»¥é˜²æ­¢è¯»å–å·²ç»å…³é—­çš„channelï¼Œé€ æˆè¯»åˆ°æ•°æ®ä¸ºé€šé“æ‰€å­˜å‚¨çš„æ•°æ®ç±»å‹çš„é›¶å€¼ã€‚</p>
<ul>
<li>ç”¨æ³•</li>
</ul>
<pre tabindex="0"><code>for x := range ch{
    fmt.Println(x)
}
</code></pre><h1 id="ä½¿ç”¨vok---ch--selectæ“ä½œåˆ¤æ–­channelæ˜¯å¦å…³é—­">ä½¿ç”¨v,ok := &lt;-ch + selectæ“ä½œåˆ¤æ–­channelæ˜¯å¦å…³é—­ <a href="#%e4%bd%bf%e7%94%a8vok---ch--select%e6%93%8d%e4%bd%9c%e5%88%a4%e6%96%adchannel%e6%98%af%e5%90%a6%e5%85%b3%e9%97%ad" class="anchor">ğŸ”—</a></h1><ul>
<li>åœºæ™¯</li>
</ul>
<p><code>v,ok := &lt;-ch + select</code>æ“ä½œåˆ¤æ–­channelæ˜¯å¦å…³é—­</p>
<ul>
<li>åŸç†</li>
</ul>
<p>okçš„ç»“æœå’Œå«ä¹‰ï¼š</p>
<pre tabindex="0"><code>- `true`ï¼šè¯»åˆ°é€šé“æ•°æ®ï¼Œä¸ç¡®å®šæ˜¯å¦å…³é—­ï¼Œå¯èƒ½channelè¿˜æœ‰ä¿å­˜çš„æ•°æ®ï¼Œä½†channelå·²å…³é—­ã€‚
- `false`ï¼šé€šé“å…³é—­ï¼Œæ— æ•°æ®è¯»åˆ°ã€‚
</code></pre><p>ä»å…³é—­çš„channelè¯»å€¼è¯»åˆ°æ˜¯channelæ‰€ä¼ é€’æ•°æ®ç±»å‹çš„é›¶å€¼ï¼Œè¿™ä¸ªé›¶å€¼æœ‰å¯èƒ½æ˜¯å‘é€è€…å‘é€çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯channelå…³é—­äº†ã€‚</p>
<p><code>_, ok := &lt;-ch</code>ä¸selecté…åˆä½¿ç”¨çš„ï¼Œå½“okä¸ºfalseæ—¶ï¼Œä»£è¡¨äº†channelå·²ç»closeã€‚</p>
<p>ä¸‹é¢è§£é‡ŠåŸå› ï¼Œ<code>_,ok := &lt;-ch</code>å¯¹åº”çš„å‡½æ•°æ˜¯<code>func chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool)</code>ï¼Œå…¥å‚blockå«ä¹‰æ˜¯å½“å‰goroutineæ˜¯å¦å¯é˜»å¡ï¼Œå½“blockä¸ºfalseä»£è¡¨çš„æ˜¯selectæ“ä½œï¼Œä¸å¯é˜»å¡å½“å‰goroutineçš„åœ¨channelæ“ä½œï¼Œå¦åˆ™æ˜¯æ™®é€šæ“ä½œï¼ˆå³<code>_, ok</code>ä¸åœ¨selectä¸­ï¼‰ã€‚è¿”å›å€¼selectedä»£è¡¨å½“å‰æ“ä½œæ˜¯å¦æˆåŠŸï¼Œä¸»è¦ä¸ºselectæœåŠ¡ï¼Œè¿”å›**receivedä»£è¡¨æ˜¯å¦ä»channelè¯»åˆ°æœ‰æ•ˆå€¼ã€‚**å®ƒæœ‰3ç§è¿”å›å€¼æƒ…å†µï¼š</p>
<ul>
<li>blockä¸ºfalseï¼Œå³æ‰§è¡Œselectæ—¶ï¼Œå¦‚æœchannelä¸ºç©ºï¼Œè¿”å›(false,false)ï¼Œä»£è¡¨selectæ“ä½œå¤±è´¥ï¼Œæ²¡æ¥æ”¶åˆ°å€¼ã€‚</li>
<li>å¦åˆ™ï¼Œå¦‚æœchannelå·²ç»å…³é—­ï¼Œå¹¶ä¸”æ²¡æœ‰æ•°æ®ï¼Œepå³æ¥æ”¶æ•°æ®çš„å˜é‡è®¾ç½®ä¸ºé›¶å€¼ï¼Œè¿”å›(true,false)ï¼Œä»£è¡¨selectæ“ä½œæˆåŠŸï¼Œä½†channelå·²å…³é—­ï¼Œæ²¡è¯»åˆ°æœ‰æ•ˆå€¼ã€‚</li>
<li>å¦åˆ™ï¼Œå…¶ä»–è¯»åˆ°æœ‰æ•ˆæ•°æ®çš„æƒ…å†µï¼Œè¿”å›(true,ture)ã€‚</li>
</ul>
<p>æˆ‘ä»¬è€ƒè™‘_, ok := &lt;-chå’Œselectç»“åˆä½¿ç”¨çš„æƒ…å†µã€‚</p>
<p>æƒ…å†µ1ï¼šå½“chanrecvè¿”å›(false,false)æ—¶ï¼Œæœ¬è´¨æ˜¯selectæ“ä½œå¤±è´¥äº†ï¼Œæ‰€ä»¥ç›¸å…³çš„caseä¼šé˜»å¡ï¼Œä¸ä¼šæ‰§è¡Œï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼š</p>
<pre tabindex="0"><code>
func main() {
	ch := make(chan int)
	select {
	case v, ok := &lt;-ch:
		fmt.Printf(&#34;v: %v, ok: %v\n&#34;, v, ok)
	default:
		fmt.Println(&#34;nothing&#34;)
	}
}

// ç»“æœï¼š
// nothing
</code></pre><p>æƒ…å†µ2ï¼šä¸‹é¢çš„ç»“æœä¼šæ˜¯é›¶å€¼å’Œfalseï¼š</p>
<pre tabindex="0"><code>func main() {
	ch := make(chan int)

	// å¢åŠ å…³é—­
	close(ch)

	select {
	case v, ok := &lt;-ch:
		fmt.Printf(&#34;v: %v, ok: %v\n&#34;, v, ok)
	}
}

// v: 0, ok: false
</code></pre><p>æƒ…å†µ3çš„receivedä¸ºtrueï¼Œå³_, okä¸­çš„okä¸ºtrueï¼Œä¸åšè®¨è®ºäº†ï¼Œåªè®¨è®ºokä¸ºfalseçš„æƒ…å†µã€‚</p>
<p>æœ€åokä¸ºfalseçš„æ—¶å€™ï¼Œåªæœ‰æƒ…å†µ2ï¼Œæ­¤æ—¶channelå¿…ç„¶å·²ç»å…³é—­ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥åœ¨selectä¸­ç”¨okåˆ¤æ–­channelæ˜¯å¦å·²ç»å…³é—­ã€‚</p>
<ul>
<li>ç”¨æ³•</li>
</ul>
<pre tabindex="0"><code>func main() {
	ch := make(chan int, 1)

	// å‘é€1ä¸ªæ•°æ®å…³é—­channel
	ch &lt;- 1
	close(ch)
	print(&#34;close channel\n&#34;)

	// ä¸åœè¯»æ•°æ®ç›´åˆ°channelæ²¡æœ‰æœ‰æ•ˆæ•°æ®
	for {
		select {
		case v, ok := &lt;-ch:
			print(&#34;v: &#34;, v, &#34;, ok:&#34;, ok, &#34;\n&#34;)
			if !ok {
				print(&#34;channel is close\n&#34;)
				return
			}	
		default:
			print(&#34;nothing\n&#34;)
		}
	}
}

// ç»“æœ
// close channel
// v: 1, ok:true
// v: 0, ok:false
// channel is close
</code></pre><h1 id="ä½¿ç”¨selectå¤„ç†å¤šä¸ªchannel">ä½¿ç”¨selectå¤„ç†å¤šä¸ªchannel <a href="#%e4%bd%bf%e7%94%a8select%e5%a4%84%e7%90%86%e5%a4%9a%e4%b8%aachannel" class="anchor">ğŸ”—</a></h1><ul>
<li>åœºæ™¯
éœ€è¦å¯¹å¤šä¸ªé€šé“è¿›è¡ŒåŒæ—¶å¤„ç†ï¼Œä½†åªå¤„ç†æœ€å…ˆå‘ç”Ÿçš„channelæ—¶</li>
<li>åŸç†
<code>select</code>å¯ä»¥åŒæ—¶ç›‘æ§å¤šä¸ªé€šé“çš„æƒ…å†µï¼Œåªå¤„ç†æœªé˜»å¡çš„caseã€‚<strong>å½“é€šé“ä¸ºnilæ—¶ï¼Œå¯¹åº”çš„caseæ°¸è¿œä¸ºé˜»å¡ï¼Œæ— è®ºè¯»å†™ã€‚ç‰¹æ®Šå…³æ³¨ï¼šæ™®é€šæƒ…å†µä¸‹ï¼Œå¯¹nilçš„é€šé“å†™æ“ä½œæ˜¯è¦panicçš„ã€‚</strong></li>
<li>ç”¨æ³•</li>
</ul>
<pre tabindex="0"><code>// åˆ†é…jobæ—¶ï¼Œå¦‚æœæ”¶åˆ°å…³é—­çš„é€šçŸ¥åˆ™é€€å‡ºï¼Œä¸åˆ†é…job
func (h *Handler) handle(job *Job) {
    select {
    case h.jobCh&lt;-job:
        return 
    case &lt;-h.stopCh:
        return
    }
}
</code></pre><h1 id="ä½¿ç”¨channelçš„å£°æ˜æ§åˆ¶è¯»å†™æƒé™">ä½¿ç”¨channelçš„å£°æ˜æ§åˆ¶è¯»å†™æƒé™ <a href="#%e4%bd%bf%e7%94%a8channel%e7%9a%84%e5%a3%b0%e6%98%8e%e6%8e%a7%e5%88%b6%e8%af%bb%e5%86%99%e6%9d%83%e9%99%90" class="anchor">ğŸ”—</a></h1><ul>
<li>
<p>åœºæ™¯
åç¨‹å¯¹æŸä¸ªé€šé“åªè¯»æˆ–åªå†™æ—¶</p>
<p>ç›®çš„ï¼š</p>
<ul>
<li>ä½¿ä»£ç æ›´æ˜“è¯»ã€æ›´æ˜“ç»´æŠ¤ï¼Œ</li>
<li>é˜²æ­¢åªè¯»åç¨‹å¯¹é€šé“è¿›è¡Œå†™æ•°æ®ï¼Œä½†é€šé“å·²å…³é—­ï¼Œé€ æˆpanicã€‚</li>
</ul>
</li>
<li>
<p>ç”¨æ³•</p>
<ul>
<li>å¦‚æœåç¨‹å¯¹æŸä¸ªchannelåªæœ‰å†™æ“ä½œï¼Œåˆ™è¿™ä¸ªchannelå£°æ˜ä¸ºåªå†™ã€‚</li>
<li>å¦‚æœåç¨‹å¯¹æŸä¸ªchannelåªæœ‰è¯»æ“ä½œï¼Œåˆ™è¿™ä¸ªchanneå£°æ˜ä¸ºåªè¯»ã€‚</li>
</ul>
</li>
</ul>
<pre tabindex="0"><code>// åªæœ‰generatorè¿›è¡Œå¯¹outChè¿›è¡Œå†™æ“ä½œï¼Œè¿”å›å£°æ˜
// &lt;-chan intï¼Œå¯ä»¥é˜²æ­¢å…¶ä»–åç¨‹ä¹±ç”¨æ­¤é€šé“ï¼Œé€ æˆéšè—bug
func generator(int n) &lt;-chan int {
    outCh := make(chan int)
    go func(){
        for i:=0;i&lt;n;i++{
            outCh&lt;-i
        }
    }()
    return outCh
}

// consumeråªè¯»inChçš„æ•°æ®ï¼Œå£°æ˜ä¸º&lt;-chan int
// å¯ä»¥é˜²æ­¢å®ƒå‘inChå†™æ•°æ®
func consumer(inCh &lt;-chan int) {
    for x := range inCh {
        fmt.Println(x)
    }
}
</code></pre><h1 id="ä½¿ç”¨ç¼“å†²channelå¢å¼ºå¹¶å‘">ä½¿ç”¨ç¼“å†²channelå¢å¼ºå¹¶å‘ <a href="#%e4%bd%bf%e7%94%a8%e7%bc%93%e5%86%b2channel%e5%a2%9e%e5%bc%ba%e5%b9%b6%e5%8f%91" class="anchor">ğŸ”—</a></h1><ul>
<li>åœºæ™¯
å¼‚æ­¥</li>
<li>åŸç†
æœ‰ç¼“å†²é€šé“å¯ä¾›å¤šä¸ªåç¨‹åŒæ—¶å¤„ç†ï¼Œåœ¨ä¸€å®šç¨‹åº¦å¯æé«˜å¹¶å‘æ€§ã€‚</li>
<li>ç”¨æ³•</li>
</ul>
<pre tabindex="0"><code>// æ— ç¼“å†²
ch1 := make(chan int)
ch2 := make(chan int, 0)
// æœ‰ç¼“å†²
ch3 := make(chan int, 1)
</code></pre><pre tabindex="0"><code>// ä½¿ç”¨5ä¸ª`do`åç¨‹åŒæ—¶å¤„ç†è¾“å…¥æ•°æ®
func test() {
    inCh := generator(100)
    outCh := make(chan int, 10)

    for i := 0; i &lt; 5; i++ {
        go do(inCh, outCh)
    }

    for r := range outCh {
        fmt.Println(r)
    }
}

func do(inCh &lt;-chan int, outCh chan&lt;- int) {
    for v := range inCh {
        outCh &lt;- v * v
    }
}
</code></pre><h1 id="ä¸ºæ“ä½œåŠ ä¸Šè¶…æ—¶">ä¸ºæ“ä½œåŠ ä¸Šè¶…æ—¶ <a href="#%e4%b8%ba%e6%93%8d%e4%bd%9c%e5%8a%a0%e4%b8%8a%e8%b6%85%e6%97%b6" class="anchor">ğŸ”—</a></h1><ul>
<li>åœºæ™¯
å¼‚æ­¥</li>
<li>åŸç†
ä½¿ç”¨<code>select</code>å’Œ<code>time.After</code>ï¼Œçœ‹æ“ä½œå’Œå®šæ—¶å™¨å“ªä¸ªå…ˆè¿”å›ï¼Œå¤„ç†å…ˆå®Œæˆçš„ï¼Œå°±è¾¾åˆ°äº†è¶…æ—¶æ§åˆ¶çš„æ•ˆæœ</li>
<li>ç”¨æ³•</li>
</ul>
<pre tabindex="0"><code>
func doWithTimeOut(timeout time.Duration) (int, error) {
	select {
	case ret := &lt;-do():
		return ret, nil
	case &lt;-time.After(timeout):
		return 0, errors.New(&#34;timeout&#34;)
	}
}

func do() &lt;-chan int {
	outCh := make(chan int)
	go func() {
		// do work
	}()
	return outCh
}
</code></pre><h1 id="ä½¿ç”¨closechå…³é—­æ‰€æœ‰ä¸‹æ¸¸åç¨‹">ä½¿ç”¨<code>close(ch)</code>å…³é—­æ‰€æœ‰ä¸‹æ¸¸åç¨‹ <a href="#%e4%bd%bf%e7%94%a8closech%e5%85%b3%e9%97%ad%e6%89%80%e6%9c%89%e4%b8%8b%e6%b8%b8%e5%8d%8f%e7%a8%8b" class="anchor">ğŸ”—</a></h1><ul>
<li>åœºæ™¯
é€€å‡ºæ—¶ï¼Œæ˜¾ç¤ºé€šçŸ¥æ‰€æœ‰åç¨‹é€€å‡º</li>
<li>åŸç†
æ‰€æœ‰è¯»chçš„åç¨‹éƒ½ä¼šæ”¶åˆ°close(ch)çš„ä¿¡å·</li>
<li>ç”¨æ³•</li>
</ul>
<pre tabindex="0"><code>
func (h *Handler) Stop() {
    close(h.stopCh)

    // å¯ä»¥ä½¿ç”¨WaitGroupç­‰å¾…æ‰€æœ‰åç¨‹é€€å‡º
}

// æ”¶åˆ°åœæ­¢åï¼Œä¸å†å¤„ç†è¯·æ±‚
func (h *Handler) loop() error {
    for {
        select {
        case req := &lt;-h.reqCh:
            go handle(req)
        case &lt;-h.stopCh:
            return
        }
    }
}
</code></pre><h1 id="ä½¿ç”¨chan-structä½œä¸ºä¿¡å·channel">ä½¿ç”¨chan struct{}ä½œä¸ºä¿¡å·channel <a href="#%e4%bd%bf%e7%94%a8chan-struct%e4%bd%9c%e4%b8%ba%e4%bf%a1%e5%8f%b7channel" class="anchor">ğŸ”—</a></h1><ul>
<li>åœºæ™¯
ä½¿ç”¨channelä¼ é€’ä¿¡å·ï¼Œè€Œä¸æ˜¯ä¼ é€’æ•°æ®æ—¶</li>
<li>åŸç†
æ²¡æ•°æ®éœ€è¦ä¼ é€’æ—¶ï¼Œä¼ é€’ç©ºstruct</li>
<li>ç”¨æ³•</li>
</ul>
<pre tabindex="0"><code>// ä¸Šä¾‹ä¸­çš„Handler.stopChå°±æ˜¯ä¸€ä¸ªä¾‹å­ï¼ŒstopChå¹¶ä¸éœ€è¦ä¼ é€’ä»»ä½•æ•°æ®
// åªæ˜¯è¦ç»™æ‰€æœ‰åç¨‹å‘é€é€€å‡ºçš„ä¿¡å·
type Handler struct {
    stopCh chan struct{}
    reqCh chan *Request
}
</code></pre><h1 id="ä½¿ç”¨channelä¼ é€’ç»“æ„ä½“çš„æŒ‡é’ˆè€Œéç»“æ„ä½“">ä½¿ç”¨channelä¼ é€’ç»“æ„ä½“çš„æŒ‡é’ˆè€Œéç»“æ„ä½“ <a href="#%e4%bd%bf%e7%94%a8channel%e4%bc%a0%e9%80%92%e7%bb%93%e6%9e%84%e4%bd%93%e7%9a%84%e6%8c%87%e9%92%88%e8%80%8c%e9%9d%9e%e7%bb%93%e6%9e%84%e4%bd%93" class="anchor">ğŸ”—</a></h1><ul>
<li>åœºæ™¯
ä½¿ç”¨channelä¼ é€’ç»“æ„ä½“æ•°æ®æ—¶</li>
<li>åŸç†
channelæœ¬è´¨ä¸Šä¼ é€’çš„æ˜¯æ•°æ®çš„æ‹·è´ï¼Œæ‹·è´çš„æ•°æ®è¶Šå°ä¼ è¾“æ•ˆç‡è¶Šé«˜ï¼Œä¼ é€’ç»“æ„ä½“æŒ‡é’ˆï¼Œæ¯”ä¼ é€’ç»“æ„ä½“æ›´é«˜æ•ˆ</li>
<li>ç”¨æ³•</li>
</ul>
<pre tabindex="0"><code>reqCh chan *Request

// å¥½è¿‡
reqCh chan Request
</code></pre><h1 id="ä½¿ç”¨channelä¼ é€’channel">ä½¿ç”¨channelä¼ é€’channel <a href="#%e4%bd%bf%e7%94%a8channel%e4%bc%a0%e9%80%92channel" class="anchor">ğŸ”—</a></h1><ul>
<li>åœºæ™¯
ä½¿ç”¨åœºæ™¯æœ‰ç‚¹å¤šï¼Œé€šå¸¸æ˜¯ç”¨æ¥è·å–ç»“æœã€‚</li>
<li>åŸç†
channelå¯ä»¥ç”¨æ¥ä¼ é€’å˜é‡ï¼Œchannelè‡ªèº«ä¹Ÿæ˜¯å˜é‡ï¼Œå¯ä»¥ä¼ é€’è‡ªå·±ã€‚</li>
<li>ç”¨æ³•</li>
</ul>
<pre tabindex="0"><code>
package main

import (
	&#34;fmt&#34;
	&#34;math/rand&#34;
	&#34;sync&#34;
	&#34;time&#34;
)

func main() {
	reqs := []int{1, 2, 3, 4, 5, 6, 7, 8, 9}

	// å­˜æ”¾ç»“æœçš„channelçš„channel
	outs := make(chan chan int, len(reqs))
	var wg sync.WaitGroup
	wg.Add(len(reqs))
	for _, x := range reqs {
		o := handle(&amp;wg, x)
		outs &lt;- o
	}

	go func() {
		wg.Wait()
		close(outs)
	}()

	// è¯»å–ç»“æœï¼Œç»“æœæœ‰åº
	for o := range outs {
		fmt.Println(&lt;-o)
	}
}

// handle å¤„ç†è¯·æ±‚ï¼Œè€—æ—¶éšæœºæ¨¡æ‹Ÿ
func handle(wg *sync.WaitGroup, a int) chan int {
	out := make(chan int)
	go func() {
		time.Sleep(time.Duration(rand.Intn(3)) * time.Second)
		out &lt;- a
		wg.Done()
	}()
	return out
}
</code></pre><blockquote>
<p>æœ¬æ–‡æ”¶é›†æ¥æºï¼š <a href="http://lessisbetter.site/2019/01/20/golang-channel-all-usage/">http://lessisbetter.site/2019/01/20/golang-channel-all-usage/</a></p>
</blockquote>

    </div>

    
</section>


            </div>
            <div class="side">
                <div class="side-categories">
    <h2>Categories</h2>
    <hr />

    <ul>
        
            <li>
                <a href="/categories/ai">ai(3)</a>
            </li>
        
            <li>
                <a href="/categories/go">go(23)</a>
            </li>
        
            <li>
                <a href="/categories/%E4%BB%A3%E7%A0%81">ä»£ç (2)</a>
            </li>
        
            <li>
                <a href="/categories/%E5%B7%A5%E5%85%B7">å·¥å…·(8)</a>
            </li>
        
            <li>
                <a href="/categories/%E9%80%86%E5%90%91">é€†å‘(3)</a>
            </li>
        
            <li>
                <a href="/categories/%E9%9D%A2%E8%AF%95">é¢è¯•(5)</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/note/">Recent Note</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/note/%E6%9E%B6%E6%9E%84%E8%80%83%E7%82%B9/">åœºæ™¯æ€»ç»“</a>
            </li>
        
            <li>
                <a href="/note/rdis-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%9B%AA%E5%B4%A9%E5%87%BB%E7%A9%BF%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/">ç¼“å­˜ç©¿é€ã€é›ªå´©ã€å‡»ç©¿çš„è§£å†³æ–¹æ³•</a>
            </li>
        
            <li>
                <a href="/note/redis-%E5%8D%95%E7%BA%BF%E7%A8%8B%E7%9A%84redis%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%AB/">å•çº¿ç¨‹çš„redisä¸ºä»€ä¹ˆå¿«</a>
            </li>
        
            <li>
                <a href="/note/redis-%E6%80%BB%E7%BB%93/">redisæ€»ç»“</a>
            </li>
        
            <li>
                <a href="/note/mysql-%E6%80%BB%E7%BB%93/">mysqlæ€»ç»“</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/android/">Recent Android</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/android/redroid%E4%BD%BF%E7%94%A8/">Redroidå®‰å“å®¹å™¨</a>
            </li>
        
            <li>
                <a href="/android/%E5%85%A5%E9%97%A8/">é€†å‘ç¯å¢ƒ-æ‚</a>
            </li>
        
            <li>
                <a href="/android/frida%E6%95%99%E7%A8%8B/">fridaæ•™ç¨‹</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/tool/">Recent Tool</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/tool/linux-almalinux%E4%BC%98%E5%8C%96/">AlmaLinux10</a>
            </li>
        
            <li>
                <a href="/tool/almalinux-k8s/">AlmaLinux-k8så®‰è£…</a>
            </li>
        
            <li>
                <a href="/tool/vscode%E6%8A%98%E8%85%BE/">vscodeæŠ˜è…¾</a>
            </li>
        
            <li>
                <a href="/tool/linux-ubuntu%E4%BC%98%E5%8C%96/">Ubuntuå¼€æœºä¼˜åŒ–</a>
            </li>
        
            <li>
                <a href="/tool/shell-ssh_script/">sshå¸¸ç”¨è„šæœ¬</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/llm/">Recent Llm</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/llm/transformers-%E5%85%A5%E9%97%A8%E7%AF%87/">Transformers-å…¥é—¨ç¯‡</a>
            </li>
        
            <li>
                <a href="/llm/%E6%A8%A1%E5%9E%8Bvllm%E9%83%A8%E7%BD%B2/">AIæ¨¡å‹VLLMéƒ¨ç½²</a>
            </li>
        
            <li>
                <a href="/llm/%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83/">AIæ¨¡å‹å¾®è°ƒ</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/go/">Recent Go</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/go/go%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0%E6%B7%B7%E5%90%88%E5%86%99%E5%B1%8F%E9%9A%9Cgc%E6%A8%A1%E5%BC%8F%E5%85%A8%E6%80%BB%E7%BB%93/">Goä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœGCæ¨¡å¼å…¨æ€»ç»“</a>
            </li>
        
            <li>
                <a href="/go/go%E4%B8%ADmake%E4%B8%8Enew%E5%8C%BA%E5%88%AB/">Goä¸­makeä¸newåŒºåˆ«</a>
            </li>
        
            <li>
                <a href="/go/go%E5%B8%B8%E7%94%A8bug%E5%92%8C%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%96%B9%E6%B3%95/">Goå¸¸ç”¨bugå’Œæ€§èƒ½é—®é¢˜çš„å®è·µæ–¹æ³•</a>
            </li>
        
            <li>
                <a href="/go/grpc%E6%80%BB%E7%BB%93/">GRPCç¬”è®°</a>
            </li>
        
            <li>
                <a href="/go/go%E7%9A%84defer%E6%80%BB%E7%BB%93/">Goçš„deferæ€»ç»“</a>
            </li>
        
    </ul>
</div>

                
            </div>
        </main>
        <footer class="footer">
    <div class="footer-row">
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/note/index.xml">
                    Feed of Note
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/android/index.xml">
                    Feed of Android
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/tool/index.xml">
                    Feed of Tool
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/llm/index.xml">
                    Feed of Llm
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/go/index.xml">
                    Feed of Go
                    <i class="icofont-rss"></i>
                </a>
            
        

        
            
            
        
    </div>

    
</footer>

    </body>
</html>
