<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1">




<title>GRPCç¬”è®° | Abnerçš„åšå®¢</title>
<link rel="canonical" href="https://abnerxc.github.io/go/grpc%E6%80%BB%E7%BB%93/">
<meta property="og:type" content="article" />
<meta property="og:title" content="GRPCç¬”è®° | Abnerçš„åšå®¢" />
<meta property="og:url" content="https://abnerxc.github.io/go/grpc%E6%80%BB%E7%BB%93/" />








<link rel="stylesheet" href="/lib/icofont/icofont.min.css" />
<link rel="stylesheet" href="/css/syntax.css" />
<link rel="stylesheet" href="/css/style.css" />
<link rel="stylesheet" href="/css/custom.css" />
<script src="/js/copy-code-block.js"></script>
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

    </head>

    <body>
        <header class="header-wrapper">
    <div class="header">
        <a class="site-title" href="https://abnerxc.github.io/">Abnerçš„åšå®¢</a>

        <nav class="menu">
            
        </nav>
    </div>
</header>

        <main class="main-wrapper">
            <div class="main">
                

<section class="single">
    <h1 class="title">GRPCç¬”è®°</h1>

    <div class="tip">
        <time datetime="2024-07-22 18:35:11 &#43;0800 CST">2024/07/22</time>
        <span class="split">Â·</span>
        <span> 1724 words </span>
        <span class="split">Â·</span>
        <span>
            9 minutes to read
        </span>
    </div>

    <div class="taxonomies">
        
        <div>
            Categories:
            
                <a href="/categories/go">Go</a>
            
        </div>
        

        
    </div>

    
    
    <div class="post-toc">
        <h3>ç›®å½•</h3>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#å®‰è£…protobuf">å®‰è£…Protobuf</a></li>
    <li><a href="#protoæ–‡ä»¶ç¼–å†™">protoæ–‡ä»¶ç¼–å†™</a></li>
    <li><a href="#protoæ–‡ä»¶ä»‹ç»">protoæ–‡ä»¶ä»‹ç»</a></li>
    <li><a href="#æœåŠ¡ç«¯ç¼–å†™">æœåŠ¡ç«¯ç¼–å†™</a></li>
    <li><a href="#å®¢æˆ·ç«¯ç¼–å†™">å®¢æˆ·ç«¯ç¼–å†™</a></li>
    <li><a href="#è®¤è¯">è®¤è¯</a></li>
    <li><a href="#interceptor-æ‹¦æˆªå™¨">Interceptor æ‹¦æˆªå™¨</a></li>
    <li><a href="#å†…ç½®trace">å†…ç½®Trace</a></li>
  </ul>
</nav>
    </div>
    

    <hr />

    <div class="content">
        <h1 id="å®‰è£…protobuf">å®‰è£…Protobuf <a href="#%e5%ae%89%e8%a3%85protobuf" class="anchor">ğŸ”—</a></h1><ol>
<li>ä¸‹è½½<a href="https://github.com/protocolbuffers/protobuf/releases">Protocol Buffers</a></li>
</ol>
<ul>
<li>é…ç½®ç¯å¢ƒå˜é‡ï¼Œmacoså¦‚ä¸‹:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span>$PATH:$JAVA_HOME/bin:<span style="color:#66d9ef">$(</span>go env GOPATH<span style="color:#66d9ef">)</span>/bin:/Users/abner/tools/platform-tools:/Users/abner/tools/apache-maven-3.9.11/bin:/Users/abner/tools/protoc-32.0-osx-x86_64/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>æ‰§è¡Œsource ~/.zshrc 
</span></span></code></pre></div><ul>
<li>æœ€åç»ˆç«¯è¾“å…¥<code>protoc</code> éªŒè¯</li>
</ul>
<ol start="2">
<li>å®‰è£…gRPCæ ¸å¿ƒåº“</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>go get google.golang.org/grpc
</span></span></code></pre></div><ol start="3">
<li>ä¸Šé¢å®‰è£…çš„æ˜¯protocolç¼–è¯‘å™¨,ä»–å¯ä»¥ç”Ÿæˆä¸åŒè¯­è¨€ä»£ç ã€‚æ¥ç€å®‰è£…goè¯­è¨€çš„ä»£ç ç”Ÿæˆå·¥å…·<code>protoc-gen-go</code>ï¼Œå…¶ä»–è¯­è¨€è‡ªè¡Œç ”ç©¶</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
</span></span><span style="display:flex;"><span>go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
</span></span></code></pre></div><h1 id="protoæ–‡ä»¶ç¼–å†™">protoæ–‡ä»¶ç¼–å†™ <a href="#proto%e6%96%87%e4%bb%b6%e7%bc%96%e5%86%99" class="anchor">ğŸ”—</a></h1><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>//è¿™æ˜¯åœ¨è¯´æ˜ä½¿ç”¨çš„æ˜¯proto3è¯­æ³•
</span></span><span style="display:flex;"><span>syntax <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;proto3&#34;</span>;
</span></span><span style="display:flex;"><span>//è¿™äº‹åœ¨è¯´æ˜ç”Ÿæˆçš„è·¯å¾„,è¿™é‡Œçš„.è¡¨ç¤ºå½“å‰ç›®å½•,serviceä»£ç ç”Ÿæˆçš„goæ–‡ä»¶åŒ…åæ˜¯service
</span></span><span style="display:flex;"><span>option go_package <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;.;service&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// å®šä¹‰æœåŠ¡Greeterï¼Œè¿™ä¸ªæœåŠ¡ä¸­æœ‰ä¸€ä¸ªrpcæ–¹æ³•SayHelloï¼Œè¯·æ±‚å‚æ•°æ˜¯HelloRequestï¼Œè¿”å›å‚æ•°æ˜¯HelloReplyã€‚ä¸€ä¸ªæ–‡ä»¶å¯ä»¥å®šä¹‰å¤šä¸ªserviceæœåŠ¡ï¼Œå¯ä»¥æŠŠä¸€ç»„ç›¸å…³çš„
</span></span><span style="display:flex;"><span>service Greeter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  rpc SayHello <span style="color:#f92672">(</span>HelloRequest<span style="color:#f92672">)</span> returns <span style="color:#f92672">(</span>HelloReply<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// è¯·æ±‚å‚æ•°
</span></span><span style="display:flex;"><span>message HelloRequest <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  string reqName <span style="color:#f92672">=</span> 1;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// å“åº”å‚æ•°
</span></span><span style="display:flex;"><span>message HelloReply <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  string respMsg <span style="color:#f92672">=</span> 1;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>ç¼–å†™å®Œä¸Šé¢å†…å®¹åï¼Œåœ¨æ–‡ä»¶ç›®å½•æ‰§è¡Œ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>protoc --go_out<span style="color:#f92672">=</span>.  greeter.proto
</span></span><span style="display:flex;"><span>protoc --go-grpc_out<span style="color:#f92672">=</span>.  greeter.proto
</span></span></code></pre></div><h1 id="protoæ–‡ä»¶ä»‹ç»">protoæ–‡ä»¶ä»‹ç» <a href="#proto%e6%96%87%e4%bb%b6%e4%bb%8b%e7%bb%8d" class="anchor">ğŸ”—</a></h1><blockquote>
<p>message</p>
</blockquote>
<p>message: protobufä¸­å®šä¹‰ä¸€ä¸ªæ¶ˆæ¯ç±»å‹æ˜¯é€šè¿‡å…³é”®å­—messageå­—æ®µæŒ‡å®šçš„ã€‚ç±»ä¼¼c++ä¸­çš„class,javaä¸­çš„class,goä¸­çš„structï¼Œä¸€ä¸ªprotoæ–‡ä»¶ä¸­å¯ä»¥å®šä¹‰å¤šä¸ªæ¶ˆæ¯ç±»å‹</p>
<blockquote>
<p>å­—æ®µè§„åˆ™</p>
</blockquote>
<p>required: è¡¨ç¤ºå­—æ®µå¿…é¡»èµ‹å€¼,å¦åˆ™ç¼–è¯‘ä¸è¿‡ã€‚åœ¨proto3ä¸­ï¼Œrequiredå­—æ®µå·²å¼ƒç”¨
optional: è¡¨ç¤ºå­—æ®µå¯ä»¥ä¸èµ‹å€¼ã€‚åœ¨proto3ä¸­ï¼Œrequiredã€optionalå­—æ®µå·²éƒ½å·²ç»é»˜è®¤optional
repeated: è¡¨ç¤ºå­—æ®µå¯ä»¥é‡å¤èµ‹å€¼,åœ¨goä¸­ä¼šè¢«å®šä¹‰ä¸ºåˆ‡ç‰‡</p>
<blockquote>
<p>æ¶ˆæ¯å·</p>
</blockquote>
<p>åœ¨æ¶ˆæ¯ä½“çš„å®šä¹‰ä¸­ï¼Œæ¯ä¸ªå­—æ®µéƒ½å¿…é¡»è¦æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ï¼Œæ ‡è¯†ä»[1,2^29-1]èŒƒå›´å†…çš„ä¸€ä¸ªæ•´æ•°</p>
<blockquote>
<p>åµŒå¥—æ¶ˆæ¯</p>
</blockquote>
<p>å¯ä»¥åœ¨å…¶ä»–æ¶ˆæ¯ç±»å‹ä¸­å®šä¹‰ä½¿ç”¨æ¶ˆæ¯ï¼Œä¾‹å¦‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>message Father <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    message Son <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        string name <span style="color:#f92672">=</span> 1;
</span></span><span style="display:flex;"><span>        int32 age <span style="color:#f92672">=</span> 2;
</span></span><span style="display:flex;"><span>        repeated int32 weight <span style="color:#f92672">=</span> 3;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    repeated Son sons <span style="color:#f92672">=</span> 1;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>å¦‚æœè¦åœ¨å¤–éƒ¨ä½¿ç”¨è¿™ä¸ªæ¶ˆæ¯ç±»å‹ï¼Œéœ€è¦Father.Sonçš„å½¢å¼ä½¿ç”¨ã€‚å¦‚ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>message Family <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Father.Son one <span style="color:#f92672">=</span> 1;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>æœåŠ¡å®šä¹‰</p>
</blockquote>
<p>åœ¨protoæ–‡ä»¶ä¸­å®šä¹‰æœåŠ¡ï¼ŒæœåŠ¡ä¸­å¯ä»¥å®šä¹‰å¤šä¸ªæ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½å¯¹åº”ä¸€ä¸ªRPCæ–¹æ³•ã€‚ä¾‹å¦‚ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>service GoodsService <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    rpc Serarch<span style="color:#f92672">(</span>SearchRequest<span style="color:#f92672">)</span> returns <span style="color:#f92672">(</span>SearchResponse<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h1 id="æœåŠ¡ç«¯ç¼–å†™">æœåŠ¡ç«¯ç¼–å†™ <a href="#%e6%9c%8d%e5%8a%a1%e7%ab%af%e7%bc%96%e5%86%99" class="anchor">ğŸ”—</a></h1><p>server.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>package main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;demo/grpc/pb&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;runtime&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>const port <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;:50051&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>type ServerDemo struct <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	pb.UnimplementedGreeterServer
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func <span style="color:#f92672">(</span>s *ServerDemo<span style="color:#f92672">)</span> SayHello<span style="color:#f92672">(</span>ctx context.Context, req *pb.HelloRequest<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>resp *pb.HelloReply, err error<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	msg :<span style="color:#f92672">=</span> fmt.Sprintf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello,%s[rpc-server,os=%s,nowNanosecond=%d]&#34;</span>,
</span></span><span style="display:flex;"><span>		req.ReqName, runtime.GOOS, time.Now<span style="color:#f92672">()</span>.Nanosecond<span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> &amp;pb.HelloReply<span style="color:#f92672">{</span>RespMsg: msg<span style="color:#f92672">}</span>, nil
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func main<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	listen, err :<span style="color:#f92672">=</span> net.Listen<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;tcp&#34;</span>, port<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		panic<span style="color:#f92672">(</span>err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	newServer :<span style="color:#f92672">=</span> grpc.NewServer<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>	pb.RegisterGreeterServer<span style="color:#f92672">(</span>newServer, &amp;ServerDemo<span style="color:#f92672">{})</span>
</span></span><span style="display:flex;"><span>	err <span style="color:#f92672">=</span> newServer.Serve<span style="color:#f92672">(</span>listen<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	fmt.Println<span style="color:#f92672">(</span>err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h1 id="å®¢æˆ·ç«¯ç¼–å†™">å®¢æˆ·ç«¯ç¼–å†™ <a href="#%e5%ae%a2%e6%88%b7%e7%ab%af%e7%bc%96%e5%86%99" class="anchor">ğŸ”—</a></h1><p>client.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>package main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;demo/grpc/pb&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>const <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>	address     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;localhost:50051&#34;</span>
</span></span><span style="display:flex;"><span>	defaultName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;kaola&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func main<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	conn, e :<span style="color:#f92672">=</span> grpc.Dial<span style="color:#f92672">(</span>address, grpc.WithInsecure<span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> e !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		panic<span style="color:#f92672">(</span>e<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	defer conn.Close<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>	c :<span style="color:#f92672">=</span> pb.NewGreeterClient<span style="color:#f92672">(</span>conn<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	reply, e :<span style="color:#f92672">=</span> c.SayHello<span style="color:#f92672">(</span>context.Background<span style="color:#f92672">()</span>, &amp;pb.HelloRequest<span style="color:#f92672">{</span>ReqName: defaultName<span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> e !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		log.Fatal<span style="color:#f92672">(</span>e<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	fmt.Println<span style="color:#f92672">(</span>reply.RespMsg<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h1 id="è®¤è¯">è®¤è¯ <a href="#%e8%ae%a4%e8%af%81" class="anchor">ğŸ”—</a></h1><p>gRPCé»˜è®¤å†…ç½®äº†ä¸¤ç§è®¤è¯æ–¹å¼ï¼š</p>
<ul>
<li>SSL/TLSè®¤è¯æ–¹å¼</li>
<li>åŸºäºTokençš„è®¤è¯æ–¹å¼
åŒæ—¶ï¼ŒgRPCæä¾›äº†æ¥å£ç”¨äºæ‰©å±•è‡ªå®šä¹‰è®¤è¯æ–¹å¼
é¡¹ç›®è·¯é¢ç»“æ„</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>|â€”â€” hello/
</span></span><span style="display:flex;"><span>    |â€”â€” client/
</span></span><span style="display:flex;"><span>        |â€”â€” main.go   // å®¢æˆ·ç«¯
</span></span><span style="display:flex;"><span>    |â€”â€” server/
</span></span><span style="display:flex;"><span>        |â€”â€” main.go   // æœåŠ¡ç«¯
</span></span><span style="display:flex;"><span>|â€”â€” proto/
</span></span><span style="display:flex;"><span>    |â€”â€” hello/
</span></span><span style="display:flex;"><span>        |â€”â€” hello.proto   // protoæè¿°æ–‡ä»¶
</span></span><span style="display:flex;"><span>        |â€”â€” hello.pb.go   // protoç¼–è¯‘åæ–‡ä»¶
</span></span></code></pre></div><h2 id="ssltlsè®¤è¯">SSL/TLSè®¤è¯ <a href="#ssltls%e8%ae%a4%e8%af%81" class="anchor">ğŸ”—</a></h2><p>è¿™é‡Œç›´æ¥æ‰©å±•helloé¡¹ç›®ï¼Œå®ç°TLSè®¤è¯æœºåˆ¶</p>
<p>é¦–å…ˆéœ€è¦å‡†å¤‡è¯ä¹¦ï¼Œåœ¨helloç›®å½•æ–°å»ºkeysç›®å½•ç”¨äºå­˜æ”¾è¯ä¹¦æ–‡ä»¶ã€‚</p>
<ol>
<li>è¯ä¹¦åˆ¶ä½œ</li>
</ol>
<p>åˆ¶ä½œç§é’¥ (.key)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Key considerations for algorithm &#34;RSA&#34; â‰¥ 2048-bit</span>
</span></span><span style="display:flex;"><span>$ openssl genrsa -out server.key <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Key considerations for algorithm &#34;ECDSA&#34; â‰¥ secp384r1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># List ECDSA the supported curves (openssl ecparam -list_curves)</span>
</span></span><span style="display:flex;"><span>$ openssl ecparam -genkey -name secp384r1 -out server.key
</span></span></code></pre></div><p>è‡ªç­¾åå…¬é’¥(x509) (PEM-encodings .pem|.crt)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ openssl req -new -x509 -sha256 -key server.key -out server.pem -days <span style="color:#ae81ff">3650</span>
</span></span></code></pre></div><p>è‡ªå®šä¹‰ä¿¡æ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>-----
</span></span><span style="display:flex;"><span>Country Name <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span> letter code<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>AU<span style="color:#f92672">]</span>:CN
</span></span><span style="display:flex;"><span>State or Province Name <span style="color:#f92672">(</span>full name<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Some-State<span style="color:#f92672">]</span>:XxXx
</span></span><span style="display:flex;"><span>Locality Name <span style="color:#f92672">(</span>eg, city<span style="color:#f92672">)</span> <span style="color:#f92672">[]</span>:XxXx
</span></span><span style="display:flex;"><span>Organization Name <span style="color:#f92672">(</span>eg, company<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Internet Widgits Pty Ltd<span style="color:#f92672">]</span>:XX Co. Ltd
</span></span><span style="display:flex;"><span>Organizational Unit Name <span style="color:#f92672">(</span>eg, section<span style="color:#f92672">)</span> <span style="color:#f92672">[]</span>:Dev
</span></span><span style="display:flex;"><span>Common Name <span style="color:#f92672">(</span>e.g. server FQDN or YOUR name<span style="color:#f92672">)</span> <span style="color:#f92672">[]</span>:server name
</span></span><span style="display:flex;"><span>Email Address <span style="color:#f92672">[]</span>:xxx@xxx.com
</span></span></code></pre></div><p>ç›®å½•ç»“æ„</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>|â€”â€” hello-tls/
</span></span><span style="display:flex;"><span>    |â€”â€” client/
</span></span><span style="display:flex;"><span>        |â€”â€” main.go   // å®¢æˆ·ç«¯
</span></span><span style="display:flex;"><span>    |â€”â€” server/
</span></span><span style="display:flex;"><span>        |â€”â€” main.go   // æœåŠ¡ç«¯
</span></span><span style="display:flex;"><span>|â€”â€” keys/                 // è¯ä¹¦ç›®å½•
</span></span><span style="display:flex;"><span>    |â€”â€” server.key
</span></span><span style="display:flex;"><span>    |â€”â€” server.pem
</span></span><span style="display:flex;"><span>|â€”â€” proto/
</span></span><span style="display:flex;"><span>    |â€”â€” hello/
</span></span><span style="display:flex;"><span>        |â€”â€” hello.proto   // protoæè¿°æ–‡ä»¶
</span></span><span style="display:flex;"><span>        |â€”â€” hello.pb.go   // protoç¼–è¯‘åæ–‡ä»¶
</span></span></code></pre></div><p>ç¤ºä¾‹ä»£ç 
ä¿®æ”¹æœåŠ¡ç«¯ä»£ç ï¼šserver/main.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>package main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pb <span style="color:#e6db74">&#34;github.com/jergoo/go-grpc-example/proto/hello&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;golang.org/x/net/context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/credentials&#34;</span> // å¼•å…¥grpcè®¤è¯åŒ…
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/grpclog&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>const <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    // Address gRPCæœåŠ¡åœ°å€
</span></span><span style="display:flex;"><span>    Address <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;127.0.0.1:50052&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// å®šä¹‰helloServiceå¹¶å®ç°çº¦å®šçš„æ¥å£
</span></span><span style="display:flex;"><span>type helloService struct<span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// HelloService HelloæœåŠ¡
</span></span><span style="display:flex;"><span>var HelloService <span style="color:#f92672">=</span> helloService<span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// SayHello å®ç°HelloæœåŠ¡æ¥å£
</span></span><span style="display:flex;"><span>func <span style="color:#f92672">(</span>h helloService<span style="color:#f92672">)</span> SayHello<span style="color:#f92672">(</span>ctx context.Context, in *pb.HelloRequest<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>*pb.HelloResponse, error<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    resp :<span style="color:#f92672">=</span> new<span style="color:#f92672">(</span>pb.HelloResponse<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    resp.Message <span style="color:#f92672">=</span> fmt.Sprintf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello %s.&#34;</span>, in.Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> resp, nil
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func main<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    listen, err :<span style="color:#f92672">=</span> net.Listen<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;tcp&#34;</span>, Address<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        grpclog.Fatalf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to listen: %v&#34;</span>, err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // TLSè®¤è¯
</span></span><span style="display:flex;"><span>    creds, err :<span style="color:#f92672">=</span> credentials.NewServerTLSFromFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;../../keys/server.pem&#34;</span>, <span style="color:#e6db74">&#34;../../keys/server.key&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        grpclog.Fatalf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to generate credentials %v&#34;</span>, err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // å®ä¾‹åŒ–grpc Server, å¹¶å¼€å¯TLSè®¤è¯
</span></span><span style="display:flex;"><span>    s :<span style="color:#f92672">=</span> grpc.NewServer<span style="color:#f92672">(</span>grpc.Creds<span style="color:#f92672">(</span>creds<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // æ³¨å†ŒHelloService
</span></span><span style="display:flex;"><span>    pb.RegisterHelloServer<span style="color:#f92672">(</span>s, HelloService<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    grpclog.Println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Listen on &#34;</span> + Address + <span style="color:#e6db74">&#34; with TLS&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    s.Serve<span style="color:#f92672">(</span>listen<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>æœåŠ¡ç«¯åœ¨å®ä¾‹åŒ–grpc Serveræ—¶ï¼Œå¯é…ç½®å¤šç§é€‰é¡¹ï¼ŒTLSè®¤è¯æ˜¯å…¶ä¸­ä¹‹ä¸€</p>
<p>å®¢æˆ·ç«¯æ·»åŠ TLSè®¤è¯ï¼šclient/main.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>package main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    pb <span style="color:#e6db74">&#34;github.com/jergoo/go-grpc-example/proto/hello&#34;</span> // å¼•å…¥protoåŒ…
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;golang.org/x/net/context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/credentials&#34;</span> // å¼•å…¥grpcè®¤è¯åŒ…
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/grpclog&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>const <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    // Address gRPCæœåŠ¡åœ°å€
</span></span><span style="display:flex;"><span>    Address <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;127.0.0.1:50052&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func main<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    // TLSè¿æ¥
</span></span><span style="display:flex;"><span>    creds, err :<span style="color:#f92672">=</span> credentials.NewClientTLSFromFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;../../keys/server.pem&#34;</span>, <span style="color:#e6db74">&#34;server name&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        grpclog.Fatalf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to create TLS credentials %v&#34;</span>, err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    conn, err :<span style="color:#f92672">=</span> grpc.Dial<span style="color:#f92672">(</span>Address, grpc.WithTransportCredentials<span style="color:#f92672">(</span>creds<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        grpclog.Fatalln<span style="color:#f92672">(</span>err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    defer conn.Close<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // åˆå§‹åŒ–å®¢æˆ·ç«¯
</span></span><span style="display:flex;"><span>    c :<span style="color:#f92672">=</span> pb.NewHelloClient<span style="color:#f92672">(</span>conn<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // è°ƒç”¨æ–¹æ³•
</span></span><span style="display:flex;"><span>    req :<span style="color:#f92672">=</span> &amp;pb.HelloRequest<span style="color:#f92672">{</span>Name: <span style="color:#e6db74">&#34;gRPC&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    res, err :<span style="color:#f92672">=</span> c.SayHello<span style="color:#f92672">(</span>context.Background<span style="color:#f92672">()</span>, req<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        grpclog.Fatalln<span style="color:#f92672">(</span>err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    grpclog.Println<span style="color:#f92672">(</span>res.Message<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>å®¢æˆ·ç«¯æ·»åŠ TLSè®¤è¯çš„æ–¹å¼å’ŒæœåŠ¡ç«¯ç±»ä¼¼ï¼Œåœ¨åˆ›å»ºè¿æ¥Dialæ—¶ï¼ŒåŒæ ·å¯ä»¥é…ç½®å¤šç§é€‰é¡¹ï¼Œåé¢çš„ç¤ºä¾‹ä¸­ä¼šçœ‹åˆ°æ›´å¤šçš„é€‰é¡¹ã€‚</p>
<h2 id="tokenè®¤è¯">Tokenè®¤è¯ <a href="#token%e8%ae%a4%e8%af%81" class="anchor">ğŸ”—</a></h2><p>å†è¿›ä¸€æ­¥ï¼Œç»§ç»­æ‰©å±•hello-tlsé¡¹ç›®ï¼Œå®ç°TLS + Tokenè®¤è¯æœºåˆ¶ï¼Œä¹Ÿå¯ä»¥ä¸éœ€è¦TLSï¼Œä»…ä½¿ç”¨tokenã€‚ä¸‹é¢çš„ä¾‹å­ä½¿ç”¨TLS + Tokenè®¤è¯æœºåˆ¶
ç›®å½•ç»“æ„</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>|â€”â€” hello_token/
</span></span><span style="display:flex;"><span>    |â€”â€” client/
</span></span><span style="display:flex;"><span>        |â€”â€” main.go   // å®¢æˆ·ç«¯
</span></span><span style="display:flex;"><span>    |â€”â€” server/
</span></span><span style="display:flex;"><span>        |â€”â€” main.go   // æœåŠ¡ç«¯
</span></span><span style="display:flex;"><span>|â€”â€” keys/             // è¯ä¹¦ç›®å½•
</span></span><span style="display:flex;"><span>    |â€”â€” server.key
</span></span><span style="display:flex;"><span>    |â€”â€” server.pem
</span></span><span style="display:flex;"><span>|â€”â€” proto/
</span></span><span style="display:flex;"><span>    |â€”â€” hello/
</span></span><span style="display:flex;"><span>        |â€”â€” hello.proto   // protoæè¿°æ–‡ä»¶
</span></span><span style="display:flex;"><span>        |â€”â€” hello.pb.go   // protoç¼–è¯‘åæ–‡ä»¶
</span></span></code></pre></div><p>ç¤ºä¾‹ä»£ç </p>
<p>å…ˆä¿®æ”¹å®¢æˆ·ç«¯å®ç°ï¼šclient/main.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>package main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    pb <span style="color:#e6db74">&#34;github.com/jergoo/go-grpc-example/proto/hello&#34;</span> // å¼•å…¥protoåŒ…
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;golang.org/x/net/context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/credentials&#34;</span> // å¼•å…¥grpcè®¤è¯åŒ…
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/grpclog&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>const <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    // Address gRPCæœåŠ¡åœ°å€
</span></span><span style="display:flex;"><span>    Address <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;127.0.0.1:50052&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // OpenTLS æ˜¯å¦å¼€å¯TLSè®¤è¯
</span></span><span style="display:flex;"><span>    OpenTLS <span style="color:#f92672">=</span> true
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// customCredential è‡ªå®šä¹‰è®¤è¯
</span></span><span style="display:flex;"><span>type customCredential struct<span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// GetRequestMetadata å®ç°è‡ªå®šä¹‰è®¤è¯æ¥å£
</span></span><span style="display:flex;"><span>func <span style="color:#f92672">(</span>c customCredential<span style="color:#f92672">)</span> GetRequestMetadata<span style="color:#f92672">(</span>ctx context.Context, uri ...string<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>map<span style="color:#f92672">[</span>string<span style="color:#f92672">]</span>string, error<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> map<span style="color:#f92672">[</span>string<span style="color:#f92672">]</span>string<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;appid&#34;</span>:  <span style="color:#e6db74">&#34;101010&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;appkey&#34;</span>: <span style="color:#e6db74">&#34;i am key&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>, nil
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// RequireTransportSecurity è‡ªå®šä¹‰è®¤è¯æ˜¯å¦å¼€å¯TLS
</span></span><span style="display:flex;"><span>func <span style="color:#f92672">(</span>c customCredential<span style="color:#f92672">)</span> RequireTransportSecurity<span style="color:#f92672">()</span> bool <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> OpenTLS
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func main<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    var err error
</span></span><span style="display:flex;"><span>    var opts <span style="color:#f92672">[]</span>grpc.DialOption
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> OpenTLS <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        // TLSè¿æ¥
</span></span><span style="display:flex;"><span>        creds, err :<span style="color:#f92672">=</span> credentials.NewClientTLSFromFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;../../keys/server.pem&#34;</span>, <span style="color:#e6db74">&#34;server name&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            grpclog.Fatalf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to create TLS credentials %v&#34;</span>, err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        opts <span style="color:#f92672">=</span> append<span style="color:#f92672">(</span>opts, grpc.WithTransportCredentials<span style="color:#f92672">(</span>creds<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        opts <span style="color:#f92672">=</span> append<span style="color:#f92672">(</span>opts, grpc.WithInsecure<span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // ä½¿ç”¨è‡ªå®šä¹‰è®¤è¯
</span></span><span style="display:flex;"><span>    opts <span style="color:#f92672">=</span> append<span style="color:#f92672">(</span>opts, grpc.WithPerRPCCredentials<span style="color:#f92672">(</span>new<span style="color:#f92672">(</span>customCredential<span style="color:#f92672">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    conn, err :<span style="color:#f92672">=</span> grpc.Dial<span style="color:#f92672">(</span>Address, opts...<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        grpclog.Fatalln<span style="color:#f92672">(</span>err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    defer conn.Close<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // åˆå§‹åŒ–å®¢æˆ·ç«¯
</span></span><span style="display:flex;"><span>    c :<span style="color:#f92672">=</span> pb.NewHelloClient<span style="color:#f92672">(</span>conn<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // è°ƒç”¨æ–¹æ³•
</span></span><span style="display:flex;"><span>    req :<span style="color:#f92672">=</span> &amp;pb.HelloRequest<span style="color:#f92672">{</span>Name: <span style="color:#e6db74">&#34;gRPC&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    res, err :<span style="color:#f92672">=</span> c.SayHello<span style="color:#f92672">(</span>context.Background<span style="color:#f92672">()</span>, req<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        grpclog.Fatalln<span style="color:#f92672">(</span>err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    grpclog.Println<span style="color:#f92672">(</span>res.Message<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>è¿™é‡Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code>customCredential</code>ç»“æ„ï¼Œå¹¶å®ç°äº†ä¸¤ä¸ªæ–¹æ³•<code>GetRequestMetadata</code>å’Œ<code>RequireTransportSecurity</code>ã€‚è¿™æ˜¯gRPCæä¾›çš„è‡ªå®šä¹‰è®¤è¯æ–¹å¼ï¼Œæ¯æ¬¡RPCè°ƒç”¨éƒ½ä¼šä¼ è¾“è®¤è¯ä¿¡æ¯ã€‚<code>customCredential</code>å…¶å®æ˜¯å®ç°äº†<code>grpc/credential</code>åŒ…å†…çš„<code>PerRPCCredentials</code>æ¥å£ã€‚æ¯æ¬¡è°ƒç”¨ï¼Œtokenä¿¡æ¯ä¼šé€šè¿‡è¯·æ±‚çš„metadataä¼ è¾“åˆ°æœåŠ¡ç«¯ã€‚ä¸‹é¢å…·ä½“çœ‹ä¸€ä¸‹æœåŠ¡ç«¯å¦‚ä½•è·å–metadataä¸­çš„ä¿¡æ¯ã€‚</p>
<p>ä¿®æ”¹server/main.goä¸­çš„SayHelloæ–¹æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>package main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pb <span style="color:#e6db74">&#34;github.com/jergoo/go-grpc-example/proto/hello&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;golang.org/x/net/context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/codes&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/credentials&#34;</span> // å¼•å…¥grpcè®¤è¯åŒ…
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/grpclog&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/metadata&#34;</span> // å¼•å…¥grpc metaåŒ…
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>const <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    // Address gRPCæœåŠ¡åœ°å€
</span></span><span style="display:flex;"><span>    Address <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;127.0.0.1:50052&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// å®šä¹‰helloServiceå¹¶å®ç°çº¦å®šçš„æ¥å£
</span></span><span style="display:flex;"><span>type helloService struct<span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// HelloService ...
</span></span><span style="display:flex;"><span>var HelloService <span style="color:#f92672">=</span> helloService<span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// SayHello å®ç°HelloæœåŠ¡æ¥å£
</span></span><span style="display:flex;"><span>func <span style="color:#f92672">(</span>h helloService<span style="color:#f92672">)</span> SayHello<span style="color:#f92672">(</span>ctx context.Context, in *pb.HelloRequest<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>*pb.HelloResponse, error<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    // è§£æmetadaä¸­çš„ä¿¡æ¯å¹¶éªŒè¯
</span></span><span style="display:flex;"><span>    md, ok :<span style="color:#f92672">=</span> metadata.FromContext<span style="color:#f92672">(</span>ctx<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> !ok <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> nil, grpc.Errorf<span style="color:#f92672">(</span>codes.Unauthenticated, <span style="color:#e6db74">&#34;æ— Tokenè®¤è¯ä¿¡æ¯&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    var <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        appid  string
</span></span><span style="display:flex;"><span>        appkey string
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> val, ok :<span style="color:#f92672">=</span> md<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;appid&#34;</span><span style="color:#f92672">]</span>; ok <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        appid <span style="color:#f92672">=</span> val<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> val, ok :<span style="color:#f92672">=</span> md<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;appkey&#34;</span><span style="color:#f92672">]</span>; ok <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        appkey <span style="color:#f92672">=</span> val<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> appid !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;101010&#34;</span> <span style="color:#f92672">||</span> appkey !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;i am key&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> nil, grpc.Errorf<span style="color:#f92672">(</span>codes.Unauthenticated, <span style="color:#e6db74">&#34;Tokenè®¤è¯ä¿¡æ¯æ— æ•ˆ: appid=%s, appkey=%s&#34;</span>, appid, appkey<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    resp :<span style="color:#f92672">=</span> new<span style="color:#f92672">(</span>pb.HelloResponse<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    resp.Message <span style="color:#f92672">=</span> fmt.Sprintf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello %s.\nToken info: appid=%s,appkey=%s&#34;</span>, in.Name, appid, appkey<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> resp, nil
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func main<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    listen, err :<span style="color:#f92672">=</span> net.Listen<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;tcp&#34;</span>, Address<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        grpclog.Fatalf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;failed to listen: %v&#34;</span>, err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // TLSè®¤è¯
</span></span><span style="display:flex;"><span>    creds, err :<span style="color:#f92672">=</span> credentials.NewServerTLSFromFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;../../keys/server.pem&#34;</span>, <span style="color:#e6db74">&#34;../../keys/server.key&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        grpclog.Fatalf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to generate credentials %v&#34;</span>, err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // å®ä¾‹åŒ–grpc Server, å¹¶å¼€å¯TLSè®¤è¯
</span></span><span style="display:flex;"><span>    s :<span style="color:#f92672">=</span> grpc.NewServer<span style="color:#f92672">(</span>grpc.Creds<span style="color:#f92672">(</span>creds<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // æ³¨å†ŒHelloService
</span></span><span style="display:flex;"><span>    pb.RegisterHelloServer<span style="color:#f92672">(</span>s, HelloService<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    grpclog.Println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Listen on &#34;</span> + Address + <span style="color:#e6db74">&#34; with TLS + Token&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    s.Serve<span style="color:#f92672">(</span>listen<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>æœåŠ¡ç«¯å¯ä»¥ä»contextä¸­è·å–æ¯æ¬¡è¯·æ±‚çš„metadataï¼Œä»ä¸­è¯»å–å®¢æˆ·ç«¯å‘é€çš„tokenä¿¡æ¯å¹¶éªŒè¯æœ‰æ•ˆæ€§ã€‚
<code>google.golang.org/grpc/credentials/oauth</code>åŒ…å·²å®ç°äº†ç”¨äºGoogle APIçš„oauthå’ŒjwtéªŒè¯çš„æ–¹æ³•ï¼Œä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚å®ç°åˆé€‚çš„éªŒè¯æ–¹å¼ã€‚</p>
<h1 id="interceptor-æ‹¦æˆªå™¨">Interceptor æ‹¦æˆªå™¨ <a href="#interceptor-%e6%8b%a6%e6%88%aa%e5%99%a8" class="anchor">ğŸ”—</a></h1><p>grpcæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½æä¾›äº†interceptoråŠŸèƒ½ï¼ŒåŠŸèƒ½ç±»ä¼¼middlewareï¼Œå¾ˆé€‚åˆåœ¨è¿™é‡Œå¤„ç†éªŒè¯ã€æ—¥å¿—ç­‰æµç¨‹ã€‚</p>
<p>åœ¨è‡ªå®šä¹‰Tokenè®¤è¯çš„ç¤ºä¾‹ä¸­ï¼Œè®¤è¯ä¿¡æ¯æ˜¯ç”±æ¯ä¸ªæœåŠ¡ä¸­çš„æ–¹æ³•å¤„ç†å¹¶è®¤è¯çš„ï¼Œå¦‚æœæœ‰å¤§é‡çš„æ¥å£æ–¹æ³•ï¼Œè¿™ç§å§¿åŠ¿å°±å¤ªä¸ä¼˜é›…äº†ï¼Œæ¯ä¸ªæ¥å£å®ç°éƒ½è¦å…ˆå¤„ç†è®¤è¯ä¿¡æ¯ã€‚è¿™ä¸ªæ—¶å€™interceptorå°±å¯ä»¥ç”¨æ¥è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œåœ¨è¯·æ±‚è¢«è½¬åˆ°å…·ä½“æ¥å£ä¹‹å‰å¤„ç†è®¤è¯ä¿¡æ¯ï¼Œä¸€å¤„è®¤è¯ï¼Œåˆ°å¤„æ— å¿§ã€‚ åœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å¢åŠ ä¸€ä¸ªè¯·æ±‚æ—¥å¿—ï¼Œè®°å½•è¯·æ±‚ç›¸å…³çš„å‚æ•°å’Œè€—æ—¶ç­‰ç­‰ã€‚ä¿®æ”¹hello_tokené¡¹ç›®å®ç°ï¼š
ç›®å½•ç»“æ„</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>|â€”â€” hello_interceptor/
</span></span><span style="display:flex;"><span>    |â€”â€” client/
</span></span><span style="display:flex;"><span>        |â€”â€” main.go   // å®¢æˆ·ç«¯
</span></span><span style="display:flex;"><span>    |â€”â€” server/
</span></span><span style="display:flex;"><span>        |â€”â€” main.go   // æœåŠ¡ç«¯
</span></span><span style="display:flex;"><span>|â€”â€” keys/             // è¯ä¹¦ç›®å½•
</span></span><span style="display:flex;"><span>    |â€”â€” server.key
</span></span><span style="display:flex;"><span>    |â€”â€” server.pem
</span></span><span style="display:flex;"><span>|â€”â€” proto/
</span></span><span style="display:flex;"><span>    |â€”â€” hello/
</span></span><span style="display:flex;"><span>        |â€”â€” hello.proto   // protoæè¿°æ–‡ä»¶
</span></span><span style="display:flex;"><span>        |â€”â€” hello.pb.go   // protoç¼–è¯‘åæ–‡ä»¶
</span></span></code></pre></div><p>ç¤ºä¾‹ä»£ç 
æœåŠ¡ç«¯interceptorï¼š hello_interceptor/server/main.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>package main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pb <span style="color:#e6db74">&#34;github.com/jergoo/go-grpc-example/proto/hello&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;golang.org/x/net/context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/codes&#34;</span>       // grpc å“åº”çŠ¶æ€ç 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/credentials&#34;</span> // grpcè®¤è¯åŒ…
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/grpclog&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/metadata&#34;</span> // grpc metadataåŒ…
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>const <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    // Address gRPCæœåŠ¡åœ°å€
</span></span><span style="display:flex;"><span>    Address <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;127.0.0.1:50052&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// å®šä¹‰helloServiceå¹¶å®ç°çº¦å®šçš„æ¥å£
</span></span><span style="display:flex;"><span>type helloService struct<span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// HelloService HelloæœåŠ¡
</span></span><span style="display:flex;"><span>var HelloService <span style="color:#f92672">=</span> helloService<span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// SayHello å®ç°HelloæœåŠ¡æ¥å£
</span></span><span style="display:flex;"><span>func <span style="color:#f92672">(</span>h helloService<span style="color:#f92672">)</span> SayHello<span style="color:#f92672">(</span>ctx context.Context, in *pb.HelloRequest<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>*pb.HelloResponse, error<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    resp :<span style="color:#f92672">=</span> new<span style="color:#f92672">(</span>pb.HelloResponse<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    resp.Message <span style="color:#f92672">=</span> fmt.Sprintf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello %s.&#34;</span>, in.Name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> resp, nil
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func main<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    listen, err :<span style="color:#f92672">=</span> net.Listen<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;tcp&#34;</span>, Address<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        grpclog.Fatalf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to listen: %v&#34;</span>, err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    var opts <span style="color:#f92672">[]</span>grpc.ServerOption
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // TLSè®¤è¯
</span></span><span style="display:flex;"><span>    creds, err :<span style="color:#f92672">=</span> credentials.NewServerTLSFromFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;../../keys/server.pem&#34;</span>, <span style="color:#e6db74">&#34;../../keys/server.key&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        grpclog.Fatalf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to generate credentials %v&#34;</span>, err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    opts <span style="color:#f92672">=</span> append<span style="color:#f92672">(</span>opts, grpc.Creds<span style="color:#f92672">(</span>creds<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // æ³¨å†Œinterceptor
</span></span><span style="display:flex;"><span>    opts <span style="color:#f92672">=</span> append<span style="color:#f92672">(</span>opts, grpc.UnaryInterceptor<span style="color:#f92672">(</span>interceptor<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // å®ä¾‹åŒ–grpc Server
</span></span><span style="display:flex;"><span>    s :<span style="color:#f92672">=</span> grpc.NewServer<span style="color:#f92672">(</span>opts...<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // æ³¨å†ŒHelloService
</span></span><span style="display:flex;"><span>    pb.RegisterHelloServer<span style="color:#f92672">(</span>s, HelloService<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    grpclog.Println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Listen on &#34;</span> + Address + <span style="color:#e6db74">&#34; with TLS + Token + Interceptor&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    s.Serve<span style="color:#f92672">(</span>listen<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// auth éªŒè¯Token
</span></span><span style="display:flex;"><span>func auth<span style="color:#f92672">(</span>ctx context.Context<span style="color:#f92672">)</span> error <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    md, ok :<span style="color:#f92672">=</span> metadata.FromContext<span style="color:#f92672">(</span>ctx<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> !ok <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> grpc.Errorf<span style="color:#f92672">(</span>codes.Unauthenticated, <span style="color:#e6db74">&#34;æ— Tokenè®¤è¯ä¿¡æ¯&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    var <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        appid  string
</span></span><span style="display:flex;"><span>        appkey string
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> val, ok :<span style="color:#f92672">=</span> md<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;appid&#34;</span><span style="color:#f92672">]</span>; ok <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        appid <span style="color:#f92672">=</span> val<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> val, ok :<span style="color:#f92672">=</span> md<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;appkey&#34;</span><span style="color:#f92672">]</span>; ok <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        appkey <span style="color:#f92672">=</span> val<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> appid !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;101010&#34;</span> <span style="color:#f92672">||</span> appkey !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;i am key&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> grpc.Errorf<span style="color:#f92672">(</span>codes.Unauthenticated, <span style="color:#e6db74">&#34;Tokenè®¤è¯ä¿¡æ¯æ— æ•ˆ: appid=%s, appkey=%s&#34;</span>, appid, appkey<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> nil
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// interceptor æ‹¦æˆªå™¨
</span></span><span style="display:flex;"><span>func interceptor<span style="color:#f92672">(</span>ctx context.Context, req interface<span style="color:#f92672">{}</span>, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>interface<span style="color:#f92672">{}</span>, error<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    err :<span style="color:#f92672">=</span> auth<span style="color:#f92672">(</span>ctx<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> nil, err
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    // ç»§ç»­å¤„ç†è¯·æ±‚
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> handler<span style="color:#f92672">(</span>ctx, req<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>å®ç°å®¢æˆ·ç«¯interceptorï¼šhello_intercepror/client/main.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>package main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pb <span style="color:#e6db74">&#34;github.com/jergoo/go-grpc-example/proto/hello&#34;</span> // å¼•å…¥protoåŒ…
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;golang.org/x/net/context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/credentials&#34;</span> // å¼•å…¥grpcè®¤è¯åŒ…
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/grpclog&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>const <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    // Address gRPCæœåŠ¡åœ°å€
</span></span><span style="display:flex;"><span>    Address <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;127.0.0.1:50052&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // OpenTLS æ˜¯å¦å¼€å¯TLSè®¤è¯
</span></span><span style="display:flex;"><span>    OpenTLS <span style="color:#f92672">=</span> true
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// customCredential è‡ªå®šä¹‰è®¤è¯
</span></span><span style="display:flex;"><span>type customCredential struct<span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// GetRequestMetadata å®ç°è‡ªå®šä¹‰è®¤è¯æ¥å£
</span></span><span style="display:flex;"><span>func <span style="color:#f92672">(</span>c customCredential<span style="color:#f92672">)</span> GetRequestMetadata<span style="color:#f92672">(</span>ctx context.Context, uri ...string<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>map<span style="color:#f92672">[</span>string<span style="color:#f92672">]</span>string, error<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> map<span style="color:#f92672">[</span>string<span style="color:#f92672">]</span>string<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;appid&#34;</span>:  <span style="color:#e6db74">&#34;101010&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;appkey&#34;</span>: <span style="color:#e6db74">&#34;i am key&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>, nil
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// RequireTransportSecurity è‡ªå®šä¹‰è®¤è¯æ˜¯å¦å¼€å¯TLS
</span></span><span style="display:flex;"><span>func <span style="color:#f92672">(</span>c customCredential<span style="color:#f92672">)</span> RequireTransportSecurity<span style="color:#f92672">()</span> bool <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> OpenTLS
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func main<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    var err error
</span></span><span style="display:flex;"><span>    var opts <span style="color:#f92672">[]</span>grpc.DialOption
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> OpenTLS <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        // TLSè¿æ¥
</span></span><span style="display:flex;"><span>        creds, err :<span style="color:#f92672">=</span> credentials.NewClientTLSFromFile<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;../../keys/server.pem&#34;</span>, <span style="color:#e6db74">&#34;server name&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            grpclog.Fatalf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to create TLS credentials %v&#34;</span>, err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        opts <span style="color:#f92672">=</span> append<span style="color:#f92672">(</span>opts, grpc.WithTransportCredentials<span style="color:#f92672">(</span>creds<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        opts <span style="color:#f92672">=</span> append<span style="color:#f92672">(</span>opts, grpc.WithInsecure<span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // æŒ‡å®šè‡ªå®šä¹‰è®¤è¯
</span></span><span style="display:flex;"><span>    opts <span style="color:#f92672">=</span> append<span style="color:#f92672">(</span>opts, grpc.WithPerRPCCredentials<span style="color:#f92672">(</span>new<span style="color:#f92672">(</span>customCredential<span style="color:#f92672">)))</span>
</span></span><span style="display:flex;"><span>    // æŒ‡å®šå®¢æˆ·ç«¯interceptor
</span></span><span style="display:flex;"><span>    opts <span style="color:#f92672">=</span> append<span style="color:#f92672">(</span>opts, grpc.WithUnaryInterceptor<span style="color:#f92672">(</span>interceptor<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    conn, err :<span style="color:#f92672">=</span> grpc.Dial<span style="color:#f92672">(</span>Address, opts...<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        grpclog.Fatalln<span style="color:#f92672">(</span>err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    defer conn.Close<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // åˆå§‹åŒ–å®¢æˆ·ç«¯
</span></span><span style="display:flex;"><span>    c :<span style="color:#f92672">=</span> pb.NewHelloClient<span style="color:#f92672">(</span>conn<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    // è°ƒç”¨æ–¹æ³•
</span></span><span style="display:flex;"><span>    req :<span style="color:#f92672">=</span> &amp;pb.HelloRequest<span style="color:#f92672">{</span>Name: <span style="color:#e6db74">&#34;gRPC&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    res, err :<span style="color:#f92672">=</span> c.SayHello<span style="color:#f92672">(</span>context.Background<span style="color:#f92672">()</span>, req<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> err !<span style="color:#f92672">=</span> nil <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        grpclog.Fatalln<span style="color:#f92672">(</span>err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    grpclog.Println<span style="color:#f92672">(</span>res.Message<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// interceptor å®¢æˆ·ç«¯æ‹¦æˆªå™¨
</span></span><span style="display:flex;"><span>func interceptor<span style="color:#f92672">(</span>ctx context.Context, method string, req, reply interface<span style="color:#f92672">{}</span>, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption<span style="color:#f92672">)</span> error <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    start :<span style="color:#f92672">=</span> time.Now<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    err :<span style="color:#f92672">=</span> invoker<span style="color:#f92672">(</span>ctx, method, req, reply, cc, opts...<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    grpclog.Printf<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;method=%s req=%v rep=%v duration=%s error=%v\n&#34;</span>, method, req, reply, time.Since<span style="color:#f92672">(</span>start<span style="color:#f92672">)</span>, err<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> err
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h1 id="å†…ç½®trace">å†…ç½®Trace <a href="#%e5%86%85%e7%bd%aetrace" class="anchor">ğŸ”—</a></h1><p>grpcå†…ç½®äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„è¯·æ±‚è¿½è¸ªï¼ŒåŸºäº<code>golang.org/x/net/trace</code>åŒ…å®ç°ï¼Œé»˜è®¤æ˜¯å¼€å¯çŠ¶æ€ï¼Œå¯ä»¥æŸ¥çœ‹äº‹ä»¶å’Œè¯·æ±‚æ—¥å¿—ï¼Œå¯¹äºåŸºæœ¬çš„è¯·æ±‚çŠ¶æ€æŸ¥çœ‹è°ƒè¯•ä¹Ÿæ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯åŸºæœ¬ä¸€è‡´ï¼Œè¿™é‡Œä»¥æœåŠ¡ç«¯å¼€å¯trace serverä¸ºä¾‹ï¼Œä¿®æ”¹helloé¡¹ç›®æœåŠ¡ç«¯ä»£ç ï¼š
ç›®å½•ç»“æ„</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>|â€”â€” hello_trace/
</span></span><span style="display:flex;"><span>    |â€”â€” client/
</span></span><span style="display:flex;"><span>        |â€”â€” main.go   // å®¢æˆ·ç«¯
</span></span><span style="display:flex;"><span>    |â€”â€” server/
</span></span><span style="display:flex;"><span>        |â€”â€” main.go   // æœåŠ¡ç«¯
</span></span><span style="display:flex;"><span>|â€”â€” proto/
</span></span><span style="display:flex;"><span>    |â€”â€” hello/
</span></span><span style="display:flex;"><span>        |â€”â€” hello.proto   // protoæè¿°æ–‡ä»¶
</span></span><span style="display:flex;"><span>        |â€”â€” hello.pb.go   // protoç¼–è¯‘åæ–‡ä»¶
</span></span></code></pre></div><p>ç¤ºä¾‹ä»£ç </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;github.com/jergoo/go-grpc-example/proto/hello&#34;</span> <span style="color:#75715e">// å¼•å…¥ç¼–è¯‘ç”Ÿæˆçš„åŒ…</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;golang.org/x/net/context&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;golang.org/x/net/trace&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;google.golang.org/grpc/grpclog&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Address gRPCæœåŠ¡åœ°å€</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Address</span> = <span style="color:#e6db74">&#34;127.0.0.1:50052&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å®šä¹‰helloServiceå¹¶å®ç°çº¦å®šçš„æ¥å£</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">helloService</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// HelloService HelloæœåŠ¡</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">HelloService</span> = <span style="color:#a6e22e">helloService</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SayHello å®ç°HelloæœåŠ¡æ¥å£</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#a6e22e">helloService</span>) <span style="color:#a6e22e">SayHello</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">in</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">HelloRequest</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">HelloResponse</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resp</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">HelloResponse</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Message</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Hello %s.&#34;</span>, <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resp</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">listen</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">Address</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">grpclog</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;failed to listen: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å®ä¾‹åŒ–grpc Server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">NewServer</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ³¨å†ŒHelloService</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">RegisterHelloServer</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">HelloService</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å¼€å¯trace</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">startTrace</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">grpclog</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Listen on &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">Address</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>(<span style="color:#a6e22e">listen</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">startTrace</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">AuthRequest</span> = <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#66d9ef">any</span>, <span style="color:#a6e22e">sensitive</span> <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:50051&#34;</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">grpclog</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Trace listen on 50051&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™é‡Œæˆ‘ä»¬å¼€å¯ä¸€ä¸ªhttpæœåŠ¡ç›‘å¬50051ç«¯å£ï¼Œç”¨æ¥æŸ¥çœ‹grpcè¯·æ±‚çš„traceä¿¡æ¯</p>
<h2 id="æœåŠ¡ç«¯äº‹ä»¶æŸ¥çœ‹">æœåŠ¡ç«¯äº‹ä»¶æŸ¥çœ‹ <a href="#%e6%9c%8d%e5%8a%a1%e7%ab%af%e4%ba%8b%e4%bb%b6%e6%9f%a5%e7%9c%8b" class="anchor">ğŸ”—</a></h2><p>è®¿é—®ï¼šlocalhost:50051/debug/eventsï¼Œç»“æœå¦‚å›¾ï¼š
<img src="/img/grpc_trace_events.jpg" alt="grpc-trace-events">
å¯ä»¥çœ‹åˆ°æœåŠ¡ç«¯æ³¨å†Œçš„æœåŠ¡å’ŒæœåŠ¡æ­£å¸¸å¯åŠ¨çš„äº‹ä»¶ä¿¡æ¯ã€‚</p>
<h2 id="è¯·æ±‚æ—¥å¿—ä¿¡æ¯æŸ¥çœ‹">è¯·æ±‚æ—¥å¿—ä¿¡æ¯æŸ¥çœ‹ <a href="#%e8%af%b7%e6%b1%82%e6%97%a5%e5%bf%97%e4%bf%a1%e6%81%af%e6%9f%a5%e7%9c%8b" class="anchor">ğŸ”—</a></h2><p>è®¿é—®ï¼šlocalhost:50051/debug/requestsï¼Œç»“æœå¦‚å›¾ï¼š
<img src="/img/grpc_trace_requests.jpg" alt="grpc-trace-events">
è¿™é‡Œå¯ä»¥æ˜¾ç¤ºæœ€è¿‘çš„è¯·æ±‚çŠ¶æ€ï¼ŒåŒ…æ‹¬è¯·æ±‚çš„æœåŠ¡ã€å‚æ•°ã€è€—æ—¶ã€å“åº”ï¼Œå¯¹äºç®€å•çš„çŠ¶æ€æŸ¥çœ‹è¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œé»˜è®¤å€¼æ˜¾ç¤ºæœ€è¿‘10æ¡è®°å½•ã€‚</p>

    </div>

    
</section>


            </div>
            <div class="side">
                <div class="side-categories">
    <h2>Categories</h2>
    <hr />

    <ul>
        
            <li>
                <a href="/categories/ai">ai(3)</a>
            </li>
        
            <li>
                <a href="/categories/go">go(23)</a>
            </li>
        
            <li>
                <a href="/categories/%E4%BB%A3%E7%A0%81">ä»£ç (2)</a>
            </li>
        
            <li>
                <a href="/categories/%E5%B7%A5%E5%85%B7">å·¥å…·(8)</a>
            </li>
        
            <li>
                <a href="/categories/%E9%80%86%E5%90%91">é€†å‘(3)</a>
            </li>
        
            <li>
                <a href="/categories/%E9%9D%A2%E8%AF%95">é¢è¯•(5)</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/note/">Recent Note</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/note/%E6%9E%B6%E6%9E%84%E8%80%83%E7%82%B9/">åœºæ™¯æ€»ç»“</a>
            </li>
        
            <li>
                <a href="/note/rdis-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%9B%AA%E5%B4%A9%E5%87%BB%E7%A9%BF%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/">ç¼“å­˜ç©¿é€ã€é›ªå´©ã€å‡»ç©¿çš„è§£å†³æ–¹æ³•</a>
            </li>
        
            <li>
                <a href="/note/redis-%E5%8D%95%E7%BA%BF%E7%A8%8B%E7%9A%84redis%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%AB/">å•çº¿ç¨‹çš„redisä¸ºä»€ä¹ˆå¿«</a>
            </li>
        
            <li>
                <a href="/note/redis-%E6%80%BB%E7%BB%93/">redisæ€»ç»“</a>
            </li>
        
            <li>
                <a href="/note/mysql-%E6%80%BB%E7%BB%93/">mysqlæ€»ç»“</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/android/">Recent Android</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/android/redroid%E4%BD%BF%E7%94%A8/">Redroidå®‰å“å®¹å™¨</a>
            </li>
        
            <li>
                <a href="/android/%E5%85%A5%E9%97%A8/">é€†å‘ç¯å¢ƒ-æ‚</a>
            </li>
        
            <li>
                <a href="/android/frida%E6%95%99%E7%A8%8B/">fridaæ•™ç¨‹</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/tool/">Recent Tool</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/tool/linux-almalinux%E4%BC%98%E5%8C%96/">AlmaLinux10</a>
            </li>
        
            <li>
                <a href="/tool/almalinux-k8s/">AlmaLinux-k8så®‰è£…</a>
            </li>
        
            <li>
                <a href="/tool/vscode%E6%8A%98%E8%85%BE/">vscodeæŠ˜è…¾</a>
            </li>
        
            <li>
                <a href="/tool/linux-ubuntu%E4%BC%98%E5%8C%96/">Ubuntuå¼€æœºä¼˜åŒ–</a>
            </li>
        
            <li>
                <a href="/tool/shell-ssh_script/">sshå¸¸ç”¨è„šæœ¬</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/llm/">Recent Llm</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/llm/transformers-%E5%85%A5%E9%97%A8%E7%AF%87/">Transformers-å…¥é—¨ç¯‡</a>
            </li>
        
            <li>
                <a href="/llm/%E6%A8%A1%E5%9E%8Bvllm%E9%83%A8%E7%BD%B2/">AIæ¨¡å‹VLLMéƒ¨ç½²</a>
            </li>
        
            <li>
                <a href="/llm/%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83/">AIæ¨¡å‹å¾®è°ƒ</a>
            </li>
        
    </ul>
</div>

                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/go/">Recent Go</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/go/go%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0%E6%B7%B7%E5%90%88%E5%86%99%E5%B1%8F%E9%9A%9Cgc%E6%A8%A1%E5%BC%8F%E5%85%A8%E6%80%BB%E7%BB%93/">Goä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœGCæ¨¡å¼å…¨æ€»ç»“</a>
            </li>
        
            <li>
                <a href="/go/go%E4%B8%ADmake%E4%B8%8Enew%E5%8C%BA%E5%88%AB/">Goä¸­makeä¸newåŒºåˆ«</a>
            </li>
        
            <li>
                <a href="/go/go%E5%B8%B8%E7%94%A8bug%E5%92%8C%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%96%B9%E6%B3%95/">Goå¸¸ç”¨bugå’Œæ€§èƒ½é—®é¢˜çš„å®è·µæ–¹æ³•</a>
            </li>
        
            <li>
                <a href="/go/grpc%E6%80%BB%E7%BB%93/">GRPCç¬”è®°</a>
            </li>
        
            <li>
                <a href="/go/go%E7%9A%84defer%E6%80%BB%E7%BB%93/">Goçš„deferæ€»ç»“</a>
            </li>
        
    </ul>
</div>

                
            </div>
        </main>
        <footer class="footer">
    <div class="footer-row">
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/note/index.xml">
                    Feed of Note
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/android/index.xml">
                    Feed of Android
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/tool/index.xml">
                    Feed of Tool
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/llm/index.xml">
                    Feed of Llm
                    <i class="icofont-rss"></i>
                </a>
            
        
            
            
                <a class="footer-item" href="https://abnerxc.github.io/go/index.xml">
                    Feed of Go
                    <i class="icofont-rss"></i>
                </a>
            
        

        
            
            
        
    </div>

    
</footer>

    </body>
</html>
